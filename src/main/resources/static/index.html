<!DOCTYPE html>
<html lang="en" ng-app="inodes">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>i-nodes</title>
    <link rel="stylesheet" href="./index.css">
    <script src="./tagify.min.js"></script>
    <link rel="stylesheet" href="./tagify.css">
    <link rel="stylesheet" href="/toastui-editor.min.css">
    <script src="/toastui-editor-all.min.js"></script>
    <script src="/common.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
        integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="/highlight.min.js"></script>
    <script src="/showdown.min.js"></script>
    <link rel="stylesheet" href="/nnfx-light.css">
    <link rel="stylesheet" href="/github-markdown.css">
    <script>

        class InodesSearchTag extends HTMLElement {
            constructor() {
                super()
                new MutationObserver(e => this.setup(e[0].target.innerHTML)).observe(this, { characterData: true })
            }
            connectedCallback() { this.setup(this.innerHTML) }
            setup(x) {
                let txt = x, lnk = x
                if(x.includes("|")) {
                    txt = x.split("|")[0]
                    lnk = x.split("|")[1].trim()
                }
                this.xshadow = this.attachShadow({ mode: 'open' })
                this.xshadow.innerHTML = `<code style='background: rgba(27,31,35,.05); padding: 1px 9px; font-size: 0.9em; border-radius: 5px'><a href='?q=${encodeURIComponent(lnk)}' target='_blank'>${txt}</a> <img src='/outlink.svg'/></code>`
            }
        }
        customElements.define('i-srch', InodesSearchTag)

        class ITag {
            constructor(container, app, tag, char, hits) {
                let self = this
                render('tag', {
                    ele: 'span',
                    classList: 'has-tooltip',
                    children: [
                        {
                            ele: 'span',
                            classList: 'container',
                            children: [
                                { ele: 'span', text: (hits ? "" : char) + tag }
                            ]
                        },
                        ...(hits ? [{ ele: 'span', classList: 'hits', text: ` x ${hits}` }] : []),
                        {
                            ele: 'div',
                            classList: 'tooltip',
                            children: [
                                {
                                    ele: 'div',
                                    classList: 'tt-title-container',
                                    children: [
                                        {
                                            ele: 'b',
                                            classList: 'tt-title',
                                            text: tag
                                        },
                                        ...(char == '#' ? [] : [
                                            {
                                                ele: 'span', text: ' (pseudo tag)', attribs: { style: 'font-size: 0.8em;' }
                                            }
                                        ]),
                                    ]
                                },
                                {
                                    ele: 'div',
                                    classList: 'desc'
                                },
                                ...(char == '#' ? [{
                                    ele: 'div',
                                    children: [
                                        ...(app.loggedIn() ? [{
                                            ele: 'span',
                                            text: 'watch',
                                            classList: 'tt-btn',
                                            evnts: {
                                                click: function () {
                                                    app.subscribe('TAG', tag, 'ALL')
                                                }
                                            }
                                        }] : []
                                        ),
                                        {
                                            ele: 'span', text: 'view', classList: 'tt-btn', evnts: { click: _ => app.viewTag(tag) }
                                        }
                                    ]
                                }] : []
                                )
                            ],
                            evnts: { click: e => e.stopPropagation() }
                        }
                    ],
                    evnts: {
                        click: e => {
                            let q = `${char}${tag}`
                            if (e.ctrlKey) {
                                q += " " + app.getSearchQuery()
                            }
                            app.search(q)
                        },
                        mouseenter: function (e) {
                            this.setAttribute('data-intime', +new Date());
                            let ltim = setTimeout(_ => {
                                let lt = this.getAttribute('data-intime');
                                if (!lt) return;
                                lt = +lt;
                                let ttc = this.querySelector('.tag-tooltip');
                                let tt = this.querySelector('.tag-desc');
                                if (!tt.getAttribute('desc-resolved')) {
                                    self.getTagToolTip(tag, char, app).then(x => {
                                        tt.appendChild(x);
                                        tt.setAttribute('desc-resolved', true)
                                    })
                                }
                                ttc.style.visibility = 'visible';
                            }, 600)
                            this.setAttribute('ltimer', ltim)
                        },
                        mouseleave: function () {
                            this.querySelector('.tag-tooltip').style.visibility = 'hidden'
                            this.setAttribute('data-intime', undefined);
                            clearTimeout(this.getAttribute('ltimer'))
                        }
                    }
                }, _ => _, container)
                if (hits)
                    container.appendChild(document.createElement('br'))
            }

            getTagToolTip(tag, char, app, hits) {
                if (!this._tagCache) {
                    this._tagCache = {};
                }
                let tagCache = this._tagCache;
                return new Promise((resolve, reject) => {
                    let dprom;
                    if (char != '#') {
                        dprom = new Promise((res, rej) => {
                            res({
                                ele: 'span',
                                classList: 'desc',
                                text: char != '%' ? `Content created by ${tag}` : `Content of type ${tag}`
                            })
                        })
                    } else {
                        dprom = new Promise((res, rej) => {
                            if (tagCache[tag]) {
                                return res(tagCache[tag])
                            }
                            app.getTag(tag).then(r => {
                                tagCache[tag] = {
                                    ele: 'div', children: [
                                        {
                                            ele: 'div', classList: 'doccount',
                                            text: `${Object.values(r.extra.docCount).reduce((x, z) => x + z, 0)} doc(s)`
                                        },
                                        {
                                            ele: 'span', classList: 'desc',
                                            text: r.basic.description || "No description avaialable. Edit and add a description"
                                        }
                                    ]
                                }
                                res(tagCache[tag])
                            })
                        })
                    }
                    dprom.then(x => {
                        resolve(render('tag-ttc', x))
                    })
                })
            }
        }

        class LargeInode {

            constructor(rc, app, obj) {

                function getTagsElement(tags, user, type, app) {
                    let x = document.createElement('div')
                    x.classList = "tags-container"
                    if (tags) {
                        tags.forEach(tag => new ITag(x, app, tag, '#'))
                        user && (new ITag(x, app, user, '~'))
                        type && (new ITag(x, app, type, '%'))
                    }
                    return x;
                }

                function getContextButtons(klass, obj) {
                    let self = this;
                    return {
                        ele: 'div',
                        classList: 'context-btns',
                        children: [
                            { ele: 'span', classList: 'context-btn', attribs: { title: 'pin', innerHTML: '&#128204;' }, evnts: { click: e => pinItem(e.target, obj) } },
                            { ele: 'span', classList: 'context-btn', attribs: { title: 'unpin', innerHTML: '&#128204;' }, styles: { display: "none", 'text-decoration': 'line-through', 'text-decoration-thickness': '3px' }, evnts: { click: function (e) { unpinItem(this, obj); } } },
                            ...(obj.visibility != 'g-public' ? [{ ele: 'span', classList: 'context-btn', html: '&#128274;', attribs: { title: 'Private (only visible to you)' } }] : []),
                            {
                                ele: 'span',
                                classList: 'context-btn',
                                html: '&#x26F6;',
                                attribs: { title: 'Full screen' },
                                evnts: {
                                    click: e => makeFullScreen(e.target.parentNode.nextSibling.childNodes[0])
                                }
                            }
                        ]
                    }
                }

                let pinItem = (ele, obj) => {
                    app.pin(obj.id, ele.parentNode.parentNode)
                    ele.style.display = 'none'
                    ele.nextSibling.style.display = 'inline-block'
                }

                let unpinItem = (ele, obj) => {
                    app.unpin(obj.id, ele.parentNode.parentNode)
                    ele.style.display = 'none'
                    ele.previousElementSibling.style.display = 'inline-block'
                }

                let template = (klass, obj) => {
                    let card;
                    try {
                        if (obj.needsApproval && app.currentUid() != obj.owner) {
                            card = klass.getSafeCard(obj);
                        } else {
                            if (obj.readState != 'CAN_READ') {
                                klass = new NoPermissionKlass()
                            }
                            card = klass.getCard(obj.content, obj)
                        }
                    } catch (e) {
                        card = render('inodes', {
                            ele: 'pre', classList: 'error',
                            text: `Error while processing \n${JSON.stringify(obj, null, '\t')}\n\nException: \n${e}\n${e.stack}`
                        })
                    }

                    return [
                        getContextButtons(klass, obj),
                        {
                            ele: 'div',
                            classList: 'container-parent',
                            children: [
                                {
                                    preBuilt: true,
                                    ele: card
                                }
                            ]
                        },
                        {
                            ele: 'div',
                            classList: 'tag-owner-actions',
                            children: [
                                {
                                    ele: 'div',
                                    classList: 'tag-owner',
                                    children: [
                                        {
                                            preBuilt: true,
                                            ele: getTagsElement(obj.tags, obj.owner, obj.type, app)
                                        },
                                        {
                                            ele: 'div',
                                            classList: 'user-time',
                                            styles: { float: 'right' },
                                            children: [
                                                {
                                                    ele: 'span',
                                                    classList: 'postowner',
                                                    text: `${obj.owner}`,
                                                    evnts: {
                                                        click: _ => app.searchUser(obj.owner)
                                                    }
                                                },
                                                {
                                                    ele: 'span',
                                                    classList: 'posttime',
                                                    styles: {
                                                        'font-size': '0.7em'
                                                    },
                                                    text: `${new Date(obj.postTime).toDateString()}`
                                                }
                                            ]
                                        },

                                    ]
                                },
                                {
                                    ele: 'div',
                                    classList: 'actions-list',
                                    children: [
                                        {
                                            ele: 'div',
                                            classList: 'actions',
                                            children: [
                                                {
                                                    ele: 'span',
                                                    html: `&#x25B2 ${obj.votes || 0}`,
                                                    classList: 'action-upvote',
                                                    evnts: { click: _ => app.upvoteInode(obj.id) }
                                                },
                                                {
                                                    ele: 'span',
                                                    html: `&#x25BC`,
                                                    classList: 'action-downvote',
                                                    evnts: { click: _ => app.downvoteInode(obj.id) }
                                                },
                                                ...(!app.loggedIn() ? [] : [{
                                                    ele: 'span',
                                                    text: 'edit',
                                                    classList: 'action',
                                                    evnts: { click: _ => app.editInode(obj) }
                                                }]),
                                                ...(!app.loggedIn() ? [] : [{
                                                    ele: 'span',
                                                    text: 'delete',
                                                    classList: 'action',
                                                    evnts: { click: _ => app.deleteInode(obj.id) }
                                                }]),
                                                {
                                                    ele: 'span',
                                                    text: 'comment(s)',
                                                    classList: 'action',
                                                    evnts: { click: _ => this.openComments(obj) }
                                                },
                                                {
                                                    ele: 'span',
                                                    text: 'share',
                                                    classList: 'action share-has-tooltip',
                                                    evnts: {
                                                        mouseenter: function (e) { this.children[0].style.display = 'block' },
                                                        mouseleave: function (e) { this.children[0].style.display = 'none' }
                                                    },
                                                    children: [
                                                        {
                                                            ele: 'div', classList: 'share-tooltip', children: [
                                                                {
                                                                    ele: 'b', text: 'copy ', children: [
                                                                        { ele: 'a', attribs: { href: app.getPermalink(obj.id), target: '_blank' }, text: 'url' }
                                                                    ]
                                                                },
                                                                {
                                                                    ele: 'div', children: [
                                                                        { ele: 'input', attribs: { readOnly: true, value: app.getPermalink(obj.id), style: 'width: 180px' } },
                                                                        {
                                                                            ele: 'button', text: 'copy', evnts: {
                                                                                click: function () { copyFormatted(this.previousElementSibling.value) }
                                                                            }
                                                                        }
                                                                    ]
                                                                },
                                                                ...(!klass.getCopyContent ? [] : [
                                                                    { ele: 'b', styles: { display: 'block', 'margin-top': '10px' }, text: 'or copy the content' },
                                                                    {
                                                                        ele: 'button',
                                                                        text: 'copy content',
                                                                        evnts: {
                                                                            click: _ => copyFormatted(klass.getCopyContent(obj)),
                                                                            rendered: e => e.removeAttribute('tabindex')
                                                                        }
                                                                    }
                                                                ])
                                                            ]
                                                        }
                                                    ]
                                                },
                                                ...(!app.loggedIn() ? [] : [{ ele: 'span', text: 'watch', classList: 'action', evnts: { click: _ => app.watchDoc(obj.id) } }])
                                            ]
                                        },
                                        {
                                            ele: 'div',
                                            classList: 'actions',
                                            styles: { float: 'right' },
                                            children: [
                                                { ele: 'span', classList: 'action', text: 'history', evnts: { click: _ => app.openHistory(obj.id) } },

                                                ...(!app.loggedIn() ? [] : [{ ele: 'span', classList: 'action', text: 'flag', evnts: { click: _ => app.flagInode(obj.id) } }]),

                                                /* this is temporary, we need to first build a approve applet */
                                                ...(!obj.needsApproval || app.loggedIn() || app.currentUid() == 'admin' ? [] : [{ ele: 'span', classList: 'action', text: 'approve', evnts: { click: () => app.approveInode(obj.id) } }]),

                                                ...(app.loggedIn() != 'admin' ? [] : [{ ele: 'span', text: 'trust', classList: 'action', evnts: { click: _ => app.trustInode(obj.id) } }])
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            ele: 'div',
                            classList: 'comments-pane',
                            iden: 'commentsSection',
                            children: [
                                {
                                    ele: 'div',
                                    styles: {
                                        display: 'flex',
                                        marginBottom: '10px'
                                    },
                                    children: [
                                        {
                                            ele: 'textarea',
                                            attribs: {
                                                iden: 'commentarea',
                                                rows: 2
                                            },
                                            styles: {
                                                width: '90%',
                                                border: 'solid 1px gray',
                                                resize: 'none'
                                            }
                                        },
                                        {
                                            ele: 'button',
                                            text: 'Post',
                                            styles: {
                                                width: '10%'
                                            },
                                            evnts: {
                                                click: _ => {
                                                    app.comment(obj.id, _.target.previousElementSibling.value)
                                                        .then(x => this.addCommentToList(x.json))
                                                        .catch(e => showError(e.message))
                                                }
                                            }
                                        }
                                    ]
                                },
                                { ele: 'div', classList: 'oldcomments', iden: 'comments' }
                            ]
                        }
                    ]
                }

                if (!obj.type || obj.type == "") {
                    rc.appendChild(render('inode', template(undefined, obj)));
                    return;
                }
                return app.getKlass(obj.type).then(klass => {
                    render('inode', template(klass, obj), (k, e) => this[k] = e, rc)
                    rc.style.visibility = 'visible'
                })
            }

            openComments(obj) {
                this.commentsSection.style.display = "block";
                let container = this.comments;
                container.innerHTML = ""
                get(`/posts/comments/${obj.id}`).then(resp => resp.json).then(comments => {
                    comments.sort((a, b) => a.time - b.time).forEach(comment => {
                        this.addCommentToList(comment)
                    })
                })
            }

            addCommentToList(c) {
                render('inode-comment', {
                    ele: 'div', classList: 'card',
                    children: [
                        { ele: 'span', html: JSON.parse(c.txt).replaceAll(/@([0-9A-Za-z]+)/g, '<a href="/?q=%23inodesapp%20%23viewuser !$1" target="_blank" >$1</a>') },
                        { ele: 'span', html: ` - <a href="/?q=%23inodesapp%20%23viewuser !${c.userid}">${c.userid}</a>` },
                        ...(
                            c.userid != app.currentUid() ? [] : [
                                { ele: 'span', text: 'delete', classList: 'action-btn', evnts: { click: _ => app.deleteComment(`${c.postid}/${c.userid}/${c.itime}`).then(_.target.parentNode.remove()) } }
                            ]
                        )
                    ]
                }, 0, this.comments)
            }
        }

        class SmallInode {
            constructor(ele, app, doc, renderTags) {
                if (renderTags) {
                    render('inode-s', [
                        { ele: 'div', classList: 'parent', iden: 'parent' },
                        {
                            ele: 'div', styles: { padding: '3px 5px' }, children: [
                                ...doc.tags.map(t => ({ ele: 'span', classList: 'tag', text: `#${t}` })),
                                { ele: 'span', classList: 'tag', styles: { 'font-size': '0.75em' }, title: 'owner', html: `&#x1F464; ${doc.owner}` },
                            ]
                        }
                    ], (k, v) => this[k] = v, ele)
                } else {
                    this.parent = ele;
                }
                app.getKlass(doc.type).then(klass => {
                    klass.getSmallCard && this.parent.appendChild(klass.getSmallCard(doc.content, doc))
                    ele.style.visibility = 'visible'
                })
            }
        }

        class Facets {
            constructor(facets, container, title, char, app) {
                render('facets', {
                    ele: 'div', iden: 'tagsEle',
                    children: [
                        { ele: 'h4', text: title },
                    ]
                }, (k, e) => this[k] = e, container)
                Object.keys(facets)
                    .filter(k => facets[k] > 0)
                    .map(k => ({ item: k, hits: facets[k] }))
                    .sort((a, b) => b.hits - a.hits)
                    .forEach(tag => new ITag(this.tagsEle, app, tag.item, char, tag.hits))
            }
        }

        class Searcher {

            /**
             * sb : search bar container
             * rc : result container
             * inodes : service provider
             * 
             * options:
             *  size: mini, large
             *  defQuery : default query
             *  pageSize : a page size which is used in the query
             *  sorter : a function to sort the results in UI (homepage, etc.)
             *  searchBarEle : if you have 
             */
            constructor(resultContainer, app, options) {

                let { searchInput, size, defQuery, pageSize, sorter, facetsEle, noSearchOnInit } = options
                this.app = app
                this.offset = 0
                this.pinned = {}
                this.options = options
                this.inst = Math.random()

                /* setup search bar and events */
                this.sb = searchInput
                if (!this.sb) {
                    render('searcher', {
                        ele: 'div', attribs: { style: 'border: solid 1px lightgray; padding: 2px; background: white; display: inline-flex; align-items: center; width: 100%' }, children: [
                            { ele: 'input', iden: 'sb', attribs: { style: 'border: none; outline: none; display: inline; background: transparent; width: max-content; flex-grow: 1' } },
                            { ele: 'i', attribs: { classList: 'fa fa-search' } }
                        ]
                    }, (k, v) => this[k] = v, resultContainer)
                }
                this.sb.addEventListener('input', _ => {
                    this.offset = 0
                    this.search(_.target.value)
                })

                /* setup results box */
                render('searcher', {
                    ele: 'div', classList: "posts-container", children: [
                        { ele: 'div', iden: 'pinned', classList: 'posts' },
                        { ele: 'div', iden: 'rc', classList: 'posts' },
                        { ele: 'div', iden: 'pages' }
                    ]
                }, (id, ele) => this[id] = ele, resultContainer)

                /* trigger a initial search if required */
                if (!noSearchOnInit)
                    this.search("")
            }

            search(str) {

                if (this.locked() && !confirm('You have some unsaved content, do you still want to continue?'))
                    return
                this.unlock()

                let { sb, rc, searchInput, size, defQuery, prefix, pageSize, sorter, app, offset } = { ...this, ...this.options };
                str = (str == "" ? defQuery : str) || ""
                if (str != defQuery)
                    sb.value = str
                callWithWaitUI(rc, (done) => {
                    str = (prefix ? prefix + " " : "") + str
                    app.getSearchResults(str, offset, pageSize || 10).then(d => {
                        let { results, facetResults, totalResults } = d.json

                        /* this is done in app level for a compatibility reason, dont move to inodes level */
                        results.forEach(r => r.content = (r.content == '' ? undefined : JSON.parse(r.content)))

                        /* apply custom sorting */
                        sorter && sorter(results)

                        if (totalResults < 1) {
                            rc.innerHTML = '<div class="no-post-found">No posts found</div>'
                            return done()
                        }

                        this.showResults(results).finally(_ => done())
                        this.getPaginationItem(totalResults)
                        this.populateFacets(facetResults)
                    })
                })
            }

            populateFacets(facetResults) {
                const { app, facetsEle } = { ...this, ...this.options },
                    info = { 'tags': ['Tags', '#'], 'type': ['Post types', '%'], 'owner': ['Contributors', '~'] }
                if (!facetsEle) return
                facetsEle.innerHTML = ''
                let arr = ['type', 'tags', 'owner']
                arr.forEach(key => {
                    new Facets(facetResults[key], facetsEle, info[key][0], info[key][1], app)
                })
            }

            showResults(results) {
                let { sb, rc, searchInput, size, defQuery, pageSize, sorter, app, offset } = { ...this, ...this.options };
                let proms = [], itemsByClass = {}
                rc.innerHTML = ''

                results.forEach(r => {
                    if (this.pinned[r.id])
                        return
                    if (!itemsByClass[r.type]) {
                        itemsByClass[r.type] = []
                    }
                    itemsByClass[r.type].push(r)
                    proms.push(this.showCard(r))
                })

                return Promise.all(proms).then(_ => {
                    Object.keys(itemsByClass).forEach(key => {
                        app.getKlass(key).then(klass => {
                            if (klass.postDisplay)
                                klass.postDisplay(itemsByClass[key])
                        })
                    })
                })
            }

            showCard(r) {
                let { rc, size, app, pickableResults, showTags, resultPickedCallback } = { ...this, ...this.options }

                /* make a container for each post, to keep the sort order */
                let c = render('inode', { ele: 'div', classList: `container ${size}`, styles: { borderLeft: pickableResults ? '' : `solid 4px ${randColor()}`, visibility: 'hidden' } })
                if (pickableResults) {
                    rc.appendChild(render('inode', {
                        ele: 'label', children: [
                            { ele: 'input', attribs: { type: 'radio', name: `s-inst-${this.inst}` }, classList: 'picker' },
                            {
                                ele: c, preBuilt: true,
                                evnts: {
                                    dblclick: _ => {
                                        resultPickedCallback && resultPickedCallback(r)
                                    }
                                }
                            }
                        ]
                    }))
                } else {
                    rc.appendChild(c)
                }

                if (size == 'min') {
                    new SmallInode(c, app, r, showTags)
                } else if (size == 'max') {
                    new LargeInode(c, app, r)
                }
            }

            getSearchQuery() {
                return this.sb.value
            }

            pin(id, ele) {
                ele.remove(), this.pinned.appendChild(ele)
            }

            unpin(id, ele) {
                ele.remove(), this.rc.insertBefore(ele, this.rc.firstChild)
            }

            getPaginationItem(totalResults) {
                let { pages, pageSize, offset } = { ...this, ...this.options };
                let container = {
                    ele: 'div',
                    classList: 'pages',
                    children: []
                }
                if (totalResults > pageSize) {
                    for (let i = 0; i < totalResults; i += pageSize) {
                        container.children.push(
                            {
                                ele: 'span',
                                classList: `page-btn ${i == this.offset ? "selected" : ""}`,
                                text: i / pageSize + 1,
                                evnts: {
                                    click: _ => {
                                        this.offset = i
                                        this.search(this.getSearchQuery())
                                    }
                                }
                            }
                        )
                    }
                }
                this.pages.innerHTML = ''
                this.pages.appendChild(render('paginator', container))
            }

            lock() { this._lock = true }
            locked() { return this._lock }
            unlock() { this._lock = false }
        }

        class Editor {
            constructor(obj, pane, app) {
                this.pane = pane, this.app = app
            }

            open(obj) {
                this.obj = obj
                this.pane.style.display = 'block'
                this.pane.innerHTML = ''
                render('editor', {
                    ele: 'div', classList: '$form', children: [
                        {
                            ele: 'div', classList: '$form-row $p0x10', styles: { marginTop: '15px' }, children: [
                                {
                                    ele: 'select', iden: 'typeSelector', label: 'Post type:', classList: '$form-input', attribs: { disabled: obj.id != undefined }, evnts: {
                                        rendered: e => this.app.getKlasses().then(x => {
                                            e.innerHTML = Object.keys(x).map(k => `<option value='${k}'>${k} &nbsp;  - &nbsp; ${x[k].desc}</option>`).join('')
                                            e.value = obj.type || Object.keys(x)[0]
                                            this.renderEditor(obj)
                                        }),
                                        change: _ => this.renderEditor(obj)
                                    }
                                }
                            ]
                        },
                        { ele: 'div', iden: 'editor', styles: { minHeight: '100px' }, classList: '$p10' },
                        {
                            ele: 'div', classList: '$fdrflex $p10', children: [
                                { ele: 'input', iden: 'tags', label: 'Tags: ', classList: '$p10', attribs: { placeholder: 'start typing a tag name. eg edc, hack', value: (obj.tags || []).join(' ') }, evnts: { rendered: e => tagify(e, 'tag') } }
                            ]
                        },
                        {
                            ele: 'div', classList: '$fdrflex $p10', children: [
                                {
                                    ele: 'input', label: 'Visibility: ', iden: 'visibility', placeholder: 'start typing a user or group name', evnts: {
                                        rendered: e => {
                                            let t = tagify(e, 'user')
                                            let visibility = obj.id ? (obj.needsApproval ? obj.savedVisibility : obj.visibility) : ['g-public']
                                            visibility = visibility.map(v => ({ name: v.substring(2), id: v, value: v, type: v[0] == 'g' ? 'group' : 'user' }))
                                            t.settings.whitelist.splice(0, visibility.length, ...visibility)
                                            t.removeAllTags()
                                            t.addTags(visibility)
                                        }
                                    }
                                }]
                        },
                        ...(!obj.id ? [] : [{
                            ele: 'div', classList: '$form-row $p10', children: [
                                { ele: 'input', iden: 'changeNote', label: 'What did you change ', attribs: { placeholder: 'describe what changed in this version' } }
                            ]
                        }]),
                        {
                            ele: 'div', classList: '$form-row $p10', children: [
                                { ele: 'button', text: 'Post', evnts: { click: e => this.post(e) } },
                                { ele: 'button', text: 'Cancel', evnts: { click: _ => this.close() } }
                            ]
                        },
                    ]
                }, (k, e) => this[k] = e, this.pane)
            }

            close() {
                this.pane.style.display = 'none'
            }

            renderEditor(obj) {
                this.editor.innerHTML = ''
                callWithWaitUI(this.editor, (d, s) => {
                    s(`Loading the ${obj.type || this.typeSelector.value} editor`)
                    this.app.getKlass(obj.type || this.typeSelector.value)
                        .then(klass => klass.getEditor(obj.content, obj.id ? obj : undefined))
                        .then(editor => this.editor.appendChild(editor))
                        .finally(_ => d())
                })
            }

            post(e) {
                if (this.tags.value == '') { return showError('Tags are required for a post') }
                if (this.visibility.value == '') { return showError('Tags are required for a post') }
                if (this.obj.id && this.changeNote.value == '') { return showError('Please mention what changed in this post') }
                let obj = this.app.getKlass(this.typeSelector.value).then(editor => {
                    try {
                        post(`/data?changeNote=${encodeURIComponent(this.obj.id ? this.changeNote.value : "initial version")}`, {
                            content: JSON.stringify(editor.getContent()),
                            type: this.typeSelector.value,
                            tags: JSON.parse(this.tags.value).map(t => t.value).concat(editor.getTags ? editor.getTags() : []),
                            visibility: JSON.parse(this.visibility.value).map(u => u.value),
                            savedVisibility: this.obj.savedVisibility || ['none'],
                            id: this.obj.id
                        }).then(_ => showSuccess('Posted successfully'))
                            .then(_ => this.close())
                            .catch(e => showError(e.message))
                    } catch (err) {
                        showError(err)
                    }
                })
            }
        }

        class App {

            constructor(inodes) {

                function homePageSorter(results) {
                    function array_move(arr, old_index, new_index) {
                        if (new_index >= arr.length) {
                            var k = new_index - arr.length + 1;
                            while (k--) {
                                arr.push(undefined);
                            }
                        }
                        arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);
                        return arr;
                    }
                    for (let i = 0; i < results.length; i++) {
                        if (results[i].tags.includes('homepage'))
                            array_move(results, i, 0)
                    }
                }

                this.inodes = inodes

                inodes.testLogin().catch(() => this.logout())

                let u = new URL(window.location.href)
                this.searcher = new Searcher(c('left-w85'), this, {
                    searchInput: g('searchbox'),
                    size: 'max',
                    defQuery: "#homepage/*",
                    facetsEle: c('search-facets'),
                    sorter: homePageSorter,
                    pageSize: 10,
                    noSearchOnInit: true
                })
                this.searcher.search(u.searchParams.get("q") || "")
                this.editor = new Editor({}, g('editor-pane'), this)

                this.showUserInfo()

                Notification.requestPermission().then(_ => {
                    this.setupNotificationWatcher()
                })
            }

            setupNotificationWatcher() {
                if (!this.loggedIn())
                    return
                var source = new EventSource('/notifications/stream')
                source.onmessage = event => {
                    let n = JSON.parse(event.data)
                    var notification = new Notification(n.nfrom, { body: n.ntext, icon: '/favicon.ico' })
                    this.updateNotificationsCount()
                }
            }

            logout() {
                inodes.logout().finally(_ => this.showUserInfo())
            }

            pin(id, ele) {
                this.searcher.pin(id, ele)
            }

            unpin(id, ele) {
                this.searcher.unpin(id, ele)
            }

            editInode(obj) {
                this.editor.open(obj)
            }

            watchDoc(id) {
                return this.subscribe('DOC', id, 'ALL')
            }

            getSearchQuery() {
                return this.searcher.getSearchQuery()
            }

            getSearchResults(x, o, ps) {
                return this.inodes.search(x, o, ps)
            }

            search(x) {
                return this.searcher.search(x)
            }

            refresh() {
                this.search(this.getSearchQuery())
            }

            currentUid() {
                return getCurrentUser();
            }

            loggedIn() {
                return this.currentUid() && true
            }

            comment(id, txt) {
                return this.inodes.comment(id, txt)
            }

            deleteComment(id) {
                return this.inodes.deleteComment(id)
            }

            subscribe(objtyp, objid, evnt) {
                return this.inodes.subscribe(objtyp, this.currentUid(), objid, evnt)
                    .then(e => showSuccess(`You have subscribed to ${objtyp} ${objid} for ${evnt} events`))
                    .catch(e => showError(e.message))
            }

            viewTag(tag) {
                return this.searcher.search(`#inodesapp #viewtag ${tag}`)
            }

            getTag(t) {
                return this.inodes.getTag(t)
            }

            approveInode(id) {
                return this.inodes.approveInode(id)
            }

            getPermalink(x) {
                return this.inodes.getPermalink(x)
            }

            trustInode(id) {
                post(`/trust/${id}`)
                    .then(r => showSuccess('Trusted'))
                    .catch(r => showError(r.message))
            }

            getKlass(kName) {
                return this.inodes.getKlass(kName)
            }

            getKlasses() {
                return this.inodes.getKlasses()
            }

            deleteInode(id) {
                if (!this.loggedIn()) return showError('Login to delete content')
                if (confirm('Are you sure to delete this content?'))
                    this.inodes.deleteInode(id)
                        .then(e => showSuccess(e.response))
                        .then(e => this.refresh())
                        .catch(c => showError(c.message))
            }

            openHistory(id) {
                this.search(`#inodesapp #history !${id}`)
            }

            flagInode(id) {
                this.inodes.flagInode(id)
                    .then(x => showSuccess('Flagged, a notification is sent to owner and security team'))
                    .catch(x => showError(x.message))
            }

            downvoteInode(id) {
                this.inodes.downvoteInode(id)
                    .then(a => showSuccess(a.response))
                    .catch(m => showError(m));
            }

            upvoteInode(id) {
                this.inodes.upvoteInode(id)
                    .then(a => showSuccess(a.response))
                    .catch(m => showError(m));
            }

            showUserInfo() {
                if (this.loggedIn()) {
                    c('title-right-panel').style.display = 'flex'
                    g('actions').innerHTML = ''
                    g('profilebtn').innerHTML = this.currentUid()
                    this.updateNotificationsCount();
                } else {
                    c('title-right-panel').style.display = 'none'
                    g('actions').innerHTML = `
                        <a class="action-item" href="javascript:app.openSigninPage()">Sign In</a>
                        <a class="action-item" href="javascript:app.openRegisterPage()">Sign Up</a>
                    `
                }
            }

            updateNotificationsCount() {
                get('/notifications/unseen').then(resp => {
                    let nc = +resp.response;
                    if (nc > 0) {
                        g('notifcount').style.display = 'block';
                        g('notifcount').innerHTML = nc;
                    } else {
                        g('notifcount').style.display = 'none';
                    }
                })
            }

            approveInode(docId) {
                this.inodes.approveInode(docId)
                    .then(x => showSuccess('Approved'))
                    .catch(x => showError(x.message))
            }

            searchUser(user) {
                this.search(`#inodesapp #viewuser !${user || this.currentUid()}`)
            }

            openMyPosts() {
                this.search(`~${this.currentUid()}`)
            }
            openNotifications() {
                this.search(`#inodesapp #notifications`)
            }
            openPRs() {
                this.search(`#inodesapp #mypermissionrequests`)
            }
            announceApp() {
                this.search(`#inodesapp #notifier`)
            }
            createGroup() {
                this.search("#inodesapp #creategroup")
            }
            openRegisterPage() {
                this.search('#inodesapp #register')
            }
            openSigninPage() {
                this.search('#inodesapp #login')
            }

            login(u, p) {
                post('/auth/login', {}, { 'Authorization': `Basic ${btoa(u + ":" + p)}` }).then((d) => {
                    let h = d.headers;
                    setCookie(USER_KEY, h['authinfo'].split(":")[0]);
                    setCookie(TOK_KEY, h['authinfo'].split(":")[1]);
                    showInfo(`Welcome ${u}!`)
                    this.showUserInfo()
                    this.search("")
                }).catch(e => {
                    alert(`authentication failed. error: ${e}`)
                })
            }

            lock() { this.searcher.lock() }
            locked() { return this.searcher.locked() }
            unlock() { this.searcher.unlock() }
        }

        class INodes {

            getKlass(kName) {
                return this.loadKlass(kName).then(kMeta => this.loadKlassScripts(kMeta))
            }

            getKlasses() {
                return this.klasses
            }

            constructor() {
                this.klassPromises = {}
                this.scriptPromises = {}
                this.pageSize = 10;
                this.pageNum = 0;
                this.klasses = get('/klasses').then(x => x.json).then(a => a.reduce((m, o) => { m[o.name] = o; return m }, {}))
            }

            testLogin() {
                return post('/test-login')
            }

            loadKlass(klassName) {
                return this.klasses.then(klasses => klasses[klassName])
            }

            loadScript(path, elem) {
                return new Promise((resolve, reject) => {
                    var jsElm = document.createElement("script");
                    jsElm.type = "application/javascript";
                    jsElm.src = path;
                    jsElm.addEventListener('load', e => resolve())
                    elem = elem || document.body
                    elem.appendChild(jsElm);
                });
            }

            comment(id, txt) {
                return post(`/posts/comment/${id}`, txt)
            }

            loadCss(path) {
                return new Promise((resolve, reject) => {
                    var fileref = document.createElement("link");
                    fileref.rel = "stylesheet";
                    fileref.type = "text/css";
                    fileref.href = path;
                    fileref.addEventListener("load", e => resolve())
                    document.getElementsByTagName("head")[0].appendChild(fileref)
                })
            }

            loadKlassScripts(klass) {
                let name = klass.name
                if (this.scriptPromises[name]) {
                    return this.scriptPromises[name]
                }
                this.scriptPromises[name] = new Promise((resolve, reject) => {
                    if (klass.obj) {
                        return resolve(klass.obj)
                    }
                    let proms = [];
                    klass.jsPaths.forEach(s => proms.push(this.loadScript(s)))
                    klass.cssPaths.forEach(s => proms.push(this.loadCss(s)))
                    Promise.all(proms).then(x => {
                        let k = eval(klass.name)
                        klass.obj = new k();
                        resolve(klass.obj)
                    });
                })
                return this.scriptPromises[name]
            }

            loggedIn() {
                return getCookie(USER_KEY)
            }

            search(str, offset = 0, pageSize = 10) {
                return getLast(`/data?q=${encodeURIComponent(str.replaceAll(/\![-\w]+/g, ""))}&offset=${offset}&pageSize=${pageSize}&fq=tags&fq=type&fq=owner`)
            }

            getPermalink(id) {
                let u = new URL(window.location.href)
                return `${u.protocol}//${u.host}?q=@${id}`
            }

            deleteInode = id => delet(`/data/${id}`)
            downvoteInode = id => post(`/posts/downvote/${id}`)
            upvoteInode = id => post(`/posts/upvote/${id}`)
            approveInode = id => post(`/data/${id}/approve`)
            flagInode = id => post(`/data/${id}/flag`)
            deleteComment = id => delet(`/posts/comment/${id}`)
            getTag = t => get(`/tags/${t}`).then(r => r.json)
            subscribe = (objtyp, uid, tag, evnt) => post(`/subscribe?subscriberType=USER&subscriberId=${uid}&objTyp=${objtyp}&objId=${tag}&event=${evnt}`)

            logout(e) {
                eraseCookie(USER_KEY)
                eraseCookie(TOK_KEY)
                return post('/auth/logout')
            }

            register() {
                post('/auth/register', { user: c('usernamebox').value, password: c('passwordbox').value })
                    .then(() => showSuccess('registration successful. verify your email address by clicking on the link in the email sent to you'))
                    .catch(m => showError(`registration failed. reason: ${m}`))
            }

        }

        class NoPermissionKlass {
            getCard(_, obj) {
                let noPermSpec = {
                    ele: 'div',
                    attribs: { style: 'padding: 50px' },
                    children: [
                        { ele: 'span', text: "You dont' have permissions to access this info. But you can " },
                        { ele: 'button', text: 'request', evnts: { click: () => { this.requestAccess(obj.id) } } },
                        { ele: 'span', text: " for it" }
                    ]
                };
                let permRequestedSpec = {
                    ele: 'div',
                    attribs: { style: 'padding: 50px' },
                    children: [
                        { ele: 'span', text: "Your request to get a permission on this object is still pending. You can track all your pending permission requests " },
                        { ele: 'a', text: 'here', attribs: { href: '/?q=%23inodesapp %23mypermissionrequests' } }
                    ]
                }
                return render('no-permission', obj.readState == 'PERM_REQUESTED' ? permRequestedSpec : noPermSpec)
            }
            getEditor() {
                throw new Error("You don't have permissions to edit this object")
            }
            requestAccess(id) {
                post(`/data/${id}/askPermission`, "", {})
                    .then(() => showSuccess('Your request has been sent to team owning the object. Wait till someone approves it'))
                    .catch(msg => showError(msg.message))
            }
        }

        let inodes, app;
        let tagifyTags, tagifyUsers;

        window.addEventListener('load', () => {
            inodes = new INodes();
            app = new App(inodes)
        });
    </script>
</head>

<body>
    <div class="title-bar">
        <div class="maxwidth title-box">

            <div class="title-left-panel">
                <span class="title"><a href='/'>i-nodes</a></span>
            </div>
            <div class="title-mid-panel">
                <div class="search-wrapper">
                    <input id="searchbox" class="search-input searchbox" type="text" placeholder="search">
                    <i class="fas fa-search"></i>
                </div>
            </div>
            <div class="title-right-panel">
                <button class="add-btn new-has-tooltip" title="New">
                    <i class="fas fa-plus-circle searchbar-icon"></i>
                    <div class="new-tooltip">
                        <ul style="list-style-type: none; padding: 0px; text-align: right; margin: 0px">
                            <li class="new-actions" onclick="app.editInode({})">&#128462; New Post</li>
                            <li class="new-actions" onclick="app.createGroup()">&#x1F465; New Group</li>
                            <li class="new-actions" onclick="app.announceApp()">&#x1F4E2; New Announcement</li>
                        </ul>
                    </div>
                </button>
                <button class="notification-btn" style="position:relative" onclick="app.openNotifications()">
                    <i class="fas fa-bell searchbar-icon"></i>
                    <b id="notifcount"
                        style="position: absolute; display: none; top: 0px; right: 0px; background: orange; color: white; padding: 3px 5px; border-radius: 50%; font-size: 0.8em"></b>
                </button>
                <button class="profile-btn new-has-tooltip">
                    <i class="fas fa-user searchbar-icon"></i>
                    <div class="new-tooltip">
                        <ul style="list-style-type: none; padding: 0px; text-align: right; margin: 0px">
                            <li class="new-actions" onclick="app.searchUser()" id='profilebtn'>Account</li>
                            <li class="new-actions" onclick="app.openMyPosts()">My Posts</li>
                            <li class="new-actions" onclick="app.openPRs()">My Pending PRs</li>
                            <li class="new-actions" onclick="app.logout()">Logout</li>
                        </ul>
                    </div>
                </button>
            </div>
        </div>
    </div>
    <div class="content maxwidth">
        <div id="editor-pane"></div>
        <div class="ppane">
            <div class="posts-trending">
                <div class="left-w85">
                    <!-- posts go here -->
                </div>
                <div class="right-w15">
                    <div id="actions" class="actions sidebar-item"></div>
                    <div class="search-facets"></div>
                </div>
            </div>

        </div>
        <hr />
    </div>
    <footer>

    </footer>
</body>

</html>