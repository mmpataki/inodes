<!DOCTYPE html>
<html lang="en" ng-app="inodes">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>i-nodes</title>
    <link rel="stylesheet" href="./index.css">
    <script src="/common.js"></script>
    <script src="./tagify.min.js"></script>
    <link rel="stylesheet" href="./tagify.css">
    <script>
        class INodes {
            constructor() {
                let self = this;
                this.klassPromises = {}
                this.scriptPromises = {}
                this.pageSize = 10;
                this.pageNum = 0;
                get('/klasses').then(function (data) {
                    self.populateClassTypes(JSON.parse(data.response));
                })
                this.setupSearch();
                this.showUserInfo();
            }
            setupSearch() {
                let q = new URL(window.location.href).searchParams.get("q")
                c('searchbox').value = q
                console.log(q)
                this.doSearch(q)
            }
            populateFacets(facets, elemId, searchChar) {
                let self = this;
                let dd = g(elemId)
                dd.innerHTML = ''
                let tags = [];
                Object.keys(facets).forEach(k => facets[k] > 0 ? tags.push({ item: k, hits: facets[k] }) : 1)
                tags.sort((a, b) => b.hits - a.hits);
                tags.forEach(tag => {
                    dd.appendChild(self.createTagElement(tag.item, searchChar, tag.hits))
                    dd.appendChild(document.createElement('br'))
                })
            }
            populateClassTypes(data) {
                let select = g('kclasses');
                select.addEventListener('change', e => this.klassChanged(e.target.value));
                data.forEach(klassName => {
                    select.innerHTML += `<option name='${klassName}'>${klassName}</option>`
                });
                this.klasses = {}
                this.klassChanged(data[0])
            }
            loadKlass(klassName) {
                if (this.klassPromises[klassName]) {
                    return this.klassPromises[klassName];
                }
                let self = this;
                this.klassPromises[klassName] = new Promise((resolve, reject) => {
                    if (self.klasses[klassName]) {
                        return resolve(self.klasses[klassName]);
                    }
                    get(`/klass/${klassName}`).then(d => {
                        self.klasses[klassName] = JSON.parse(d.response);
                        resolve(self.klasses[klassName])
                    })
                });
                return this.klassPromises[klassName]
            }
            klassChanged(klassName) {
                let self = this;
                this.loadKlass(klassName).then(d => {
                    this.renderInput(d.name, undefined, false)
                });
            }
            loadScript(path, callBack) {
                return new Promise((resolve, reject) => {
                    var jsElm = document.createElement("script");
                    jsElm.type = "application/javascript";
                    jsElm.src = path;
                    jsElm.addEventListener('load', e => resolve())
                    document.body.appendChild(jsElm);
                });
            }
            loadCss(path, callBack) {
                return new Promise((resolve, reject) => {
                    var fileref = document.createElement("link");
                    fileref.rel = "stylesheet";
                    fileref.type = "text/css";
                    fileref.href = path;
                    fileref.addEventListener("load", e => resolve())
                    document.getElementsByTagName("head")[0].appendChild(fileref)
                })
            }
            loadKlassScripts(klass) {
                let name = klass.name
                if (this.scriptPromises[name]) {
                    return this.scriptPromises[name]
                }
                this.scriptPromises[name] = new Promise((resolve, reject) => {
                    if (klass.obj) {
                        return resolve(klass.obj)
                    }
                    let proms = [];
                    klass.jsPaths.forEach(s => proms.push(this.loadScript(s)))
                    klass.cssPaths.forEach(s => proms.push(this.loadCss(s)))
                    Promise.all(proms).then(x => {
                        let k = eval(klass.name)
                        klass.obj = new k();
                        resolve(klass.obj)
                    });
                })
                return this.scriptPromises[name]
            }
            renderInput(klassName, obj, force) {
                let self = this;
                this.currentPost = obj
                this.loadKlass(klassName)
                    .then(klass => this.loadKlassScripts(klass))
                    .then(klassObj => {
                        let e = g('editor');
                        e.innerHTML = '';
                        if (!klassObj.inodes_editor || force || obj) {
                            klassObj.inodes_editor = klassObj.getEditor(obj)
                        }
                        e.appendChild(klassObj.inodes_editor)
                    });
            }
            loggedIn() {
                return getCookie(USER_KEY)
            }
            showUserInfo() {
                if (this.loggedIn()) {
                    g('actions').innerHTML = `
                        <a class="action-item" href="javascript:inodes.openEditor(undefined, true)">New Post</a>
                        <a class="action-item" href="javascript:inodes.openAccount()">Account (${getCurrentUser()})</a>
                        <a class="action-item" href="javascript:inodes.openMyPosts()">My Posts</a>
                        <a class="action-item" href="javascript:inodes.logout()">Logout</a>
                        <a class="action-item" href="javascript:inodes.createGroup()">New Group</a>
                    `;
                } else {
                    g('actions').innerHTML = `
                        <a class="action-item" href="javascript:inodes.openSignInPage()">Sign In</a>
                        <a class="action-item" href="javascript:inodes.openRegisterPage()">Sign Up</a>
                    `
                }
            }
            createGroup() {
                this.triggerSearch('#inodesapp #creategroup')
            }
            openSignInPage() {
                this.triggerSearch('#inodesapp #login')
            }
            post() {
                let self = this;
                let currentClass = g('kclasses').value
                let obj = this.klasses[currentClass].obj
                let content = ''
                try {
                    content = JSON.stringify(obj.getContent());
                } catch (err) {
                    showError(err);
                    return
                }
                post(
                    '/data',
                    {
                        content,
                        type: currentClass,
                        tags: JSON.parse(g('tags-editor').value).map(t => t.value).concat(obj.getTags ? obj.getTags() : []),
                        visibility: JSON.parse(g('visibility-editor').value).map(u => u.value),
                        savedVisibility: this.currentPost ? (this.currentPost.savedVisibility || ['none']) : ['none'],
                        id: this.currentPost ? this.currentPost.id : undefined
                    },
                    {
                        "Content-Type": "application/json"
                    }
                )
                    .then(e => showSuccess('Posted successfully'))
                    .catch(msg => showError(msg))
            }
            doSearch(str, offset = 0, pageSize = 10) {
                this.search(str, offset, pageSize).then(d => {
                    this.results = JSON.parse(d.response)
                    this.showResults();
                    this.populateFacets(this.results.facetResults['tags'], 'toptags', '#');
                    this.populateFacets(this.results.facetResults['type'], 'posttypes', '%');
                    this.populateFacets(this.results.facetResults['owner'], 'topcontributors', '~');
                })
            }
            search(str, offset = 0, pageSize = 10) {
                str = str ? str : ""
                str = str.replace(/\!\w+/, "")
                return get(`/data?q=${encodeURIComponent(str)}&offset=${offset}&pageSize=${pageSize}&fq=tags&fq=type&fq=owner`)
            }
            showResults() {
                let d = g('posts');
                d.innerHTML = ''
                let self = this
                let proms = []
                let itemsByClass = {};
                this.results.results.forEach(r => {
                    if (!itemsByClass[r.type]) {
                        itemsByClass[r.type] = []
                    }
                    itemsByClass[r.type].push(r)
                    proms.push(self.showCard(d, r));
                })
                Promise.all(proms).then(() => {
                    if (this.results.results.length < this.results.totalResults) {
                        d.appendChild(this.getPaginationItem(this.results));
                    }
                    // call the post display hook
                    Object.keys(itemsByClass).forEach(key => {
                        self.loadKlass(key).then(klassMeta => {
                            self.loadKlassScripts(klassMeta).then(klass => {
                                if(klass.postDisplay) {
                                    klass.postDisplay(itemsByClass[key])
                                }
                            })
                        })
                    })
                });
            }
            getSearchQuery() {
                return c('searchbox').value;
            }
            getPaginationItem(results) {
                let self = this;
                let resp = function () {
                    let container = {
                        ele: 'div',
                        classList: 'pages',
                        children: []
                    }
                    for (let i = 0; i < results.totalResults; i += self.pageSize) {
                        container.children.push(
                            {
                                ele: 'span',
                                classList: `page-btn ${(i / self.pageSize) == self.pageNum ? "selected" : ""}`,
                                text: i / self.pageSize + 1,
                                evnts: {
                                    click: function (e) {
                                        self.pageNum = i / self.pageSize
                                        self.doSearch(self.getSearchQuery(), i, self.pageSize)
                                    }
                                }
                            }
                        )
                    }
                    return container;
                }
                return render('paginator', resp());
            }
            refresh() {
                this.triggerSearch(this.getSearchQuery())
            }
            deleteInode(id) {
                if (!this.loggedIn()) {
                    return showError('Login to delete content')
                }
                if (!confirm('Are you sure to delete this content?')) {
                    return;
                }
                delet(`/data/${id}`)
                    .then(e => showSuccess(e.response))
                    .then(e => this.refresh())
                    .catch(c => showError(c));
            }
            editInode(obj) {
                if (!this.loggedIn()) {
                    return showError('Login to post / update content')
                }
                g('tags-editor').value = obj.tags.join(' ')
                let tags = obj.tags.map(t => {
                    return { name: t, id: t, value: t, description: "" }
                })
                tagifyTags.settings.whitelist.splice(0, tags.length, ...tags);
                tagifyTags.removeAllTags();
                tagifyTags.addTags(tags);

                g('kclasses').value = obj.type
                this.openEditor(obj, true)
            }
            downvoteInode(id) {
                post(`/posts/downvote/${id}`, {})
                    .then(a => showSuccess(a.response))
                    .catch(m => showError(m));
            }
            upvoteInode(id) {
                post(`/posts/upvote/${id}`, {})
                    .then(a => showSuccess(a.response))
                    .catch(m => showError(m));
            }
            showCard(d, obj) {
                let self = this;
                let template = function (klass, obj) {
                    let card;
                    try {
                        if (obj.needsApproval && getCurrentUser() && getCurrentUser() != obj.owner) {
                            card = klass.getSafeCard(obj);
                        } else {
                            card = klass.getCard(obj)
                        }
                    } catch (e) {
                        if (obj.content) {
                            obj.content = JSON.parse(obj.content)
                        }
                        card = render('inodes', {
                            ele: 'pre',
                            styles: {
                                width: "95%",
                                'background-color': 'red',
                                color: 'white',
                                padding: "10px",
                                'overflow-y': 'auto'
                            },
                            text: `Error while processing \n${JSON.stringify(obj, null, '\t')}\n\nException: \n${e.stack}`
                        })
                    }
                    let getApproveIcon = () => obj.needsApproval ? [{ ele: 'span', classList: 'action', text: 'approve', evnts: { click: () => self.approveInode(obj.id) } }] : [];
                    return {
                        ele: 'div',
                        classList: 'container',
                        styles: {
                            borderLeft: `solid 3px ${self.randColor()}`,
                            position: 'relative',
                            display: 'flex',
                            'flex-direction': 'column'
                        },
                        children: [
                            self.getContextButtons(klass, obj),
                            {
                                ele: 'div',
                                classList: 'container-parent',
                                children: [
                                    {
                                        preBuilt: true,
                                        ele: card
                                    }
                                ]
                            },
                            {
                                ele: 'div',
                                classList: 'tag-owner-actions',
                                children: [
                                    {
                                        ele: 'div',
                                        classList: 'tag-owner',
                                        children: [
                                            {
                                                preBuilt: true,
                                                ele: self.getTagsElement(obj.tags, obj.owner, obj.type)
                                            },
                                            {
                                                ele: 'div',
                                                classList: 'user-time',
                                                styles: { float: 'right' },
                                                children: [
                                                    {
                                                        ele: 'span',
                                                        classList: 'postowner',
                                                        text: `${obj.owner}`,
                                                        evnts: {
                                                            click: function (e) {
                                                                self.searchUser(obj.owner);
                                                            }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        classList: 'posttime',
                                                        styles: {
                                                            'font-size': '0.7em'
                                                        },
                                                        text: `${self.getLocalDateTime(obj.postTime)}`
                                                    }
                                                ]
                                            },

                                        ]
                                    },
                                    {
                                        ele: 'div',
                                        classList: 'actions-list',
                                        children: [
                                            {
                                                ele: 'div',
                                                classList: 'actions',
                                                children: [
                                                    {
                                                        ele: 'span',
                                                        text: `&#x25B2 ${obj.votes || 0}`,
                                                        classList: 'action-upvote',
                                                        evnts: {
                                                            click: function (e) { self.upvoteInode(obj.id) }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        text: `&#x25BC`,
                                                        classList: 'action-downvote',
                                                        evnts: {
                                                            click: function (e) { self.downvoteInode(obj.id) }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        text: 'edit',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { self.editInode(obj) }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        text: 'delete',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { self.deleteInode(obj.id) }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        text: 'comment(s)',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { self.commentInode(obj) }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        text: 'share',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { window.location = `?q=@${obj.id}` }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        text: 'watch',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { self.watchDoc(obj.id) }
                                                        }
                                                    }
                                                ]
                                            }
                                            ,
                                            {
                                                ele: 'div',
                                                classList: 'actions',
                                                styles: { float: 'right' },
                                                children: [
                                                    {
                                                        ele: 'span',
                                                        classList: 'action',
                                                        text: 'flag',
                                                        evnts: { click: () => self.flagInode(obj.id) }
                                                    },
                                                    ...getApproveIcon()
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                ele: 'div',
                                classList: 'comments-pane',
                                attribs: {
                                    id: `comment-pane-${obj.id}`
                                },
                                children: [
                                    {
                                        ele: 'div',
                                        styles: {
                                            display: 'flex',
                                            marginBottom: '10px'
                                        },
                                        children: [
                                            {
                                                ele: 'textarea',
                                                attribs: {
                                                    id: `comment-${obj.id}`,
                                                    rows: 2
                                                },
                                                styles: {
                                                    width: '90%',
                                                    border: 'solid 1px gray',
                                                    resize: 'none'
                                                }
                                            },
                                            {
                                                ele: 'button',
                                                text: 'Post',
                                                styles: {
                                                    width: '10%'
                                                },
                                                evnts: {
                                                    click: function (e) {
                                                        post(
                                                            `/posts/comment/${obj.id}`,
                                                            g(`comment-${obj.id}`).value
                                                        ).then(x => self.addCommentToList(`oldcomments-${obj.id}`, JSON.parse(x.response)))
                                                            .catch(e => showError(e.message))
                                                    }
                                                }
                                            }
                                        ]
                                    },
                                    {
                                        ele: 'div',
                                        attribs: {
                                            id: `oldcomments-${obj.id}`
                                        }
                                    }
                                ]
                            }
                        ]
                    };
                }
                if (!obj.type || obj.type == "") {
                    d.appendChild(render('inode', template(undefined, obj)));
                    return;
                }
                return new Promise(function (resolve, reject) {
                    self.loadKlass(obj.type).then(klassMeta => {
                        self.loadKlassScripts(klassMeta).then(klass => {
                            d.appendChild(render('inode', template(klass, obj)));
                            resolve()
                        })
                    })
                });
            }

            watchDoc(id) {
                post(
                    `/subscribe?subscriberType=USER&subscriberId=${getCurrentUser()}&objTyp=DOC&objId=${id}&event=ALL`,
                    "",
                    {}
                ).then(r => showSuccess('Subscribed'))
                    .catch(r => showError(r.message))
            }

            getContextButtons(klass, obj) {
                let self = this;
                let getLockIcon = () => obj.visibility != 'g-public' ? [{ ele: 'span', text: '&#128274;', attribs: { title: 'Private (only visible to you)' } }] : []
                return {
                    ele: 'div',
                    classList: 'context-btns',
                    children: [
                        ...getLockIcon(),
                        {
                            ele: 'span',
                            classList: 'context-btn',
                            text: '&#x26F6;',
                            attribs: { title: 'Full screen' },
                            evnts: {
                                click: function () {
                                    let x = document.createElement('div')
                                    x.classList = 'fullscreen-inode'
                                    document.body.appendChild(x)

                                    let cardEle = this.parentNode.nextSibling.childNodes[0], cardParent = cardEle.parentNode;

                                    let closeBtn = document.createElement('span')
                                    closeBtn.classList = 'closefullscreen-btn'
                                    closeBtn.innerHTML = '&#x2715;'
                                    closeBtn.addEventListener('click', function () {
                                        cardEle.remove();
                                        cardParent.appendChild(cardEle)
                                        x.remove();
                                        document.querySelector('.content').style.display = 'block'
                                    })

                                    document.querySelector('.content').style.display = 'none'
                                    x.appendChild(cardEle)
                                    x.appendChild(closeBtn)
                                }
                            }
                        }
                    ]
                }
            }

            approveInode(docId) {
                post(`/data/${docId}/approve`, {}, {})
                    .then(x => showSuccess('Approved'))
                    .catch(x => showError(x.message))
            }

            flagInode(docId) {
                post(`/data/${docId}/flag`, {}, {})
                    .then(x => showSuccess('Flagged, a notification is sent to owner and security team'))
                    .catch(x => showError(x.message))
            }

            searchUser(user) {
                this.triggerSearch(`#user !${user}`)
            }
            commentInode(obj) {
                let self = this;
                g(`comment-pane-${obj.id}`).style.display = "block";
                let container = g(`oldcomments-${obj.id}`);
                container.innerHTML = ""
                get(`/posts/comments/${obj.id}`).then(comments => {
                    comments = JSON.parse(comments.response)
                    comments.sort((a, b) => a.time - b.time).forEach(comment => {
                        self.addCommentToList(`oldcomments-${obj.id}`, comment)
                    })
                })
            }
            addCommentToList(parentId, comment) {
                let container = g(parentId);
                let c = document.createElement('div')
                c.classList = "inode-comment-card"
                c.innerHTML = `${JSON.parse(comment.txt).replaceAll(/@([0-9A-Za-z]+)/g, '<a href="/?q=%23user !$1" target="_blank" >$1</a>')} - <a href="/?q=%23user !${comment.userid}">${comment.userid}</a> ${this.getCommentContextButtons(comment)}`
                container.appendChild(c)
            }
            getCommentContextButtons(c) {
                if (c.userid == getCurrentUser()) {
                    return `<span onclick='inodes.deleteComment("${c.postid}/${c.userid}/${c.itime}", this.parentElement)' class='comment-action-btn'>delete</span>`
                }
                return ''
            }
            deleteComment(id, parEle) {
                delet(`/posts/comment/${id}`).then(parEle.remove())
            }
            getLocalDateTime(ep) {
                var d = new Date(ep);
                return `${d.toLocaleDateString()}`
            }
            randColor() {
                var letters = '0123456789ABCDEF';
                var color = '#';
                for (var i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }
            getTagsElement(tags, user, type) {
                let x = document.createElement('div')
                x.classList = "tags-container"
                if (!tags) return x;
                let self = this;
                tags.forEach(tag => {
                    x.appendChild(this.createTagElement(tag, '#'));
                });
                user && x.appendChild(this.createTagElement(user, '~'))
                type && x.appendChild(this.createTagElement(type, '%'))
                return x;
            }
            createTagElement(tag, char, hits) {
                let self = this;
                let t = document.createElement('span');
                t.innerHTML = `<span class='tag'>${hits ? "" : char}${tag}</span>`
                if (hits) {
                    t.innerHTML += `<span style="color: gray; font-size: 0.8em"> x ${hits}</span>`
                }
                t.addEventListener('click', e => {
                    let q = ""
                    if (e.ctrlKey) {
                        q = c('searchbox').value + " "
                    }
                    q += `${char}${tag}`
                    self.triggerSearch(q)
                })
                t.addEventListener('dblclick', e => {
                    if (char == '#')
                        self.triggerSearch(`#inodesapp #viewtag !${tag}`)
                })
                return t;
            }
            openEditor(obj, force) {
                this.renderInput(obj ? obj.type : 'posts', obj, true)
                g('editor-pane').style.display = 'block';
                g('kclasses').disabled = obj ? true : false

                let visibility = obj ? (obj.needsApproval ? obj.savedVisibility : obj.visibility) : ['g-public'];
                visibility = visibility.map(v => {
                    return { name: v.substring(2), id: v, value: v, type: v[0] == 'g' ? 'group' : 'user' }
                });
                tagifyUsers.settings.whitelist.splice(0, visibility.length, ...visibility)
                tagifyUsers.removeAllTags();
                tagifyUsers.addTags(visibility)
            }
            closeEditor() {
                g('editor-pane').style.display = 'none';
            }
            logout(e) {
                post(
                    '/auth/logout',
                    {},
                    { 'Content-Type': 'application/json' }
                )
                eraseCookie(USER_KEY)
                eraseCookie(TOK_KEY)
                this.showUserInfo()
                showSuccess('logged out successfully')
            }
            register() {
                post(
                    '/auth/register',
                    {
                        user: c('usernamebox').value,
                        password: c('passwordbox').value
                    },
                    {
                        'Content-Type': 'application/json'
                    }
                )
                    .then(() => showSuccess('registration successful. verify your email address by clicking on the link in the email sent to you'))
                    .catch(m => showError(`registration failed. reason: ${m}`))
            }
            triggerSearch(q) {
                c('searchbox').value = q;
                this.doSearch(q)
            }
            openAccount() {
                let u = getCurrentUser();
                this.triggerSearch(`#user !${u}`)
                if (!u) {
                    showWarning('You are not logged in, so all user options are not available')
                }
            }
            openMyPosts() {
                let u = getCurrentUser();
                this.triggerSearch(`~${u}`)
                if (!u) {
                    showError('You are not logged in, so all post related actions might not work')
                }
            }
            openRegisterPage() {
                this.triggerSearch('#register #inodesapp')
            }
            runCommand(scriptText, pnode, callBack) {

                if (!pnode) {
                    pnode = document.createElement('div');
                }
                pnode.innerHTML = ''

                let status = document.createElement('status')
                status.style = "display: block"
                pnode.appendChild(status);

                let out;
                if (pnode) {
                    out = document.createElement('pre');
                    out.style = "background-color: black; color: white; width: 100%; height: 200px; overflow: auto"
                    pnode.appendChild(out);
                }

                let ajax = function (method, url, data, hdrs) {
                    return new Promise((resolve, reject) => {
                        var xhttp = new XMLHttpRequest();
                        xhttp.onreadystatechange = function () {
                            if (this.readyState == 4 && this.status == 200) {
                                resolve({ response: this.responseText })
                            }
                            if (this.status == 401) {
                                reject(401);
                            }
                        };
                        xhttp.open(method, url, true);
                        hdrs && Object.keys(hdrs).forEach(key => xhttp.setRequestHeader(key, hdrs[key]))
                        xhttp.send(data);
                    });
                }
                let post = function (url, data, hdrs) {
                    return ajax('POST', url, JSON.stringify(data), hdrs);
                }

                return new Promise((resolve, reject) => {
                    post(
                        'http://inedctst01:5000/cli',
                        { script: scriptText },
                        { 'Content-Type': 'application/json' }
                    ).then(d => {
                        d = d.response
                        resolve(d)
                        status.innerHTML = `<b style="color:blue">Starting</b>`
                        var source = new EventSource(`http://inedctst01:5000/poll?rid=${d}`);
                        source.onmessage = function (event) {
                            status.innerHTML = `<b style="color:orange">Running</b>`
                            if (event.data == 'MPATAKI-STOP_EVENT-SOURCE') {
                                status.innerHTML = `<b style="color:green">Done</b>`
                                event.target.close()
                                return
                            }
                            if (out)
                                out.innerHTML += event.data + "<br/>"
                            if (callBack)
                                callBack(event.data)
                        }
                    })
                });
            }
        }

        function render(name, spec, elemCreated, container) {
            let e;
            if (!spec.preBuilt) {
                e = document.createElement(spec.ele);
                spec.iden && elemCreated(spec.iden, e)
                if (spec.text) e.innerHTML = spec.text;
                if (spec.classList) {
                    e.classList = `${name}-` + spec.classList.split(/\s+/).join(` ${name}-`)
                }
                spec.attribs && Object.keys(spec.attribs).forEach(key => {
                    e[key] = spec.attribs[key]
                })
                spec.styles && Object.keys(spec.styles).forEach(key => {
                    e.style[key] = spec.styles[key]
                })
                spec.evnts && Object.keys(spec.evnts).forEach(key => {
                    e.addEventListener(key, spec.evnts[key])
                })
                if (spec.children) {
                    if (spec.children instanceof Function) {
                        spec.children().map(x => e.appendChild(x))
                    }
                    else spec.children.forEach(child => render(name, child, elemCreated, e))
                }
            } else {
                e = spec.ele;
            }
            if (container) {
                container.appendChild(e)
                if (spec.label) {
                    let rgid = "id_" + Math.random();
                    e.id = rgid
                    let lbl = document.createElement('label')
                    lbl.innerHTML = spec.label
                    lbl.for = rgid
                    container.appendChild(lbl)
                }
                return container;
            }
            return e;
        }

        let inodes;
        var tagifyTags, tagifyUsers;

        window.addEventListener('load', () => {
            inodes = new INodes();

            // users
            tagifyUsers = new Tagify(document.querySelector('#visibility-editor'), {
                tagTextProp: 'name', // very important since a custom template is used with this property as text
                enforceWhitelist: true,
                skipInvalid: true,
                dropdown: { closeOnSelect: true, enabled: 0, searchKeys: ['value', 'name'] },
                autoComplete: { rightKey: true },
                delimiters: ' ',
                templates: {
                    tag: function (tagData) {
                        return `
                            <tag title="${tagData.type} ${tagData.name}"
                                    contenteditable='false'
                                    spellcheck='false'
                                    tabIndex="-1"
                                    class="${this.settings.classNames.tag} ${tagData.class ? tagData.class : ""}"
                                    ${this.getAttributes(tagData)}>
                                <x title='remove' class='tagify__tag__removeBtn' role='button' aria-label='remove tag'></x>
                                <div>
                                    ${tagData.type == 'user' ? '&#x1F464;' : '&#x1F465;'}
                                    <span class='tagify__tag-text'>${tagData.name}</span>
                                </div>
                            </tag>
                        `
                    },
                    dropdownItem: function (tagData) {
                        if (tagData.type == 'user') {
                            return `<div class='tagify__dropdown__item'>&#x1F464; ${tagData.name} (${tagData.id.substring(2)})</div>`;
                        } else {
                            return `<div class='tagify__dropdown__item'>&#x1F465; ${tagData.name}</div>`;
                        }
                    }
                },
                whitelist: [],
                delimiter: ' '
            })

            var controller;

            // listen to any keystrokes which modify tagify's input
            tagifyUsers.on('input', onInput)

            function onInput(e) {
                var value = e.detail.value;
                tagifyUsers.settings.whitelist.length = 0; // reset the whitelist

                // https://developer.mozilla.org/en-US/docs/Web/API/AbortController/abort
                controller && controller.abort();
                controller = new AbortController();

                // show loading animation and hide the suggestions dropdown
                tagifyUsers.loading(true).dropdown.hide.call(tagifyUsers)

                fetch(`${baseUrl}/auth/find-ug-like?term=${value}`, { signal: controller.signal })
                    .then(RES => RES.json())
                    .then(RES => RES.map(x => { return { ...x, value: x.id, type: x.id.startsWith('u') ? 'user' : 'group', name: ((!x.name || x.name == 'null') ? x.id.substring(2) : x.name) } }))
                    .then(function (whitelist) {
                        // update inwhitelist Array in-place
                        tagifyUsers.settings.whitelist.splice(0, whitelist.length, ...whitelist)
                        tagifyUsers.loading(false).dropdown.show.call(tagifyUsers); // render the suggestions dropdown
                    })
            }

            // Tags
            tagifyTags = new Tagify(document.querySelector('#tags-editor'), {
                tagTextProp: 'name', // very important since a custom template is used with this property as text
                enforceWhitelist: false,
                skipInvalid: false,
                delimiters: ' ',
                dropdown: { closeOnSelect: true, enabled: 0, searchKeys: ['value'] },
                autoComplete: { rightKey: true },
                templates: {
                    tag: function (tagData) {
                        return `
                            <tag title="${tagData.name}"
                                    contenteditable='false'
                                    spellcheck='false'
                                    tabIndex="-1"
                                    class="${this.settings.classNames.tag}"
                                    ${this.getAttributes(tagData)}>
                                <x title='remove' class='tagify__tag__removeBtn' role='button' aria-label='remove tag'></x>
                                <div description="${tagData.description}">
                                    <span class='tagify__tag-text'>${tagData.name}</span>
                                </div>
                            </tag>
                        `
                    },
                    dropdownItem: function (tagData) {
                        return `<div class='tagify__dropdown__item'>${tagData.name}</div>`;
                    }
                },
                whitelist: [],
                delimiter: ' '
            })

            var controller1;

            // listen to any keystrokes which modify tagify's input
            tagifyTags.on('input', onInputTags)

            function onInputTags(e) {
                var value = e.detail.value;
                tagifyTags.settings.whitelist.length = 0;

                controller1 && controller1.abort();
                controller1 = new AbortController();

                tagifyTags.loading(true).dropdown.hide.call(tagifyTags)

                fetch(`${baseUrl}/find-tags-like?term=${value}`, { signal: controller1.signal })
                    .then(RES => RES.json())
                    .then(RES => RES.map(x => { return { ...x, value: x.name } }))
                    .then(function (whitelist) {
                        // update inwhitelist Array in-place
                        tagifyTags.settings.whitelist.splice(0, whitelist.length, ...whitelist)
                        tagifyTags.loading(false).dropdown.show.call(tagifyTags); // render the suggestions dropdown
                    })
            }
        });
    </script>

</head>

<body>
    <div class="title-bar">
        <div class="maxwidth" style="margin: auto;">
            <span class="title">i-nodes</span>
        </div>
    </div>
    <div class="content maxwidth">
        <div id="editor-pane">
            <fieldset>
                <span onclick="inodes.closeEditor()" class="closebtn">x</span>
                <label for="kclasses" class="">Post type: </label><br />
                <select id="kclasses"></select><br /><br />
                <div id="editor"></div><br />
                <label for="tags-editor">Tags</label><br />
                <input type="text" id="tags-editor" placeholder="start typing a tag name. eg edc hack"></input><br />
                <label for="visibility-editor">Visibility</label><br />
                <input type="text" id="visibility-editor" placeholder="start typing a user or group name"></input>
                <br /><br />
                <button onclick="inodes.post()">Post</button>
            </fieldset>
        </div>
        <div class="ppane">
            <div class="searchbox-container">
                <input type="text" placeholder="search" class="searchbox" oninput="inodes.doSearch(this.value)" />
            </div>
            <div class="posts-trending">
                <div class="left-w85">
                    <div class="posts-container">
                        <div id="posts"></div>
                    </div>
                </div>
                <div class="right-w15">
                    <div>
                        <h4>Actions</h4>
                        <div id="actions" class="actions sidebar-item"></div>
                    </div>
                    <div>
                        <h4>Post types</h4>
                        <div id="posttypes" class="sidebar-item">
                        </div>
                    </div>
                    <div>
                        <h4>Top tags</h4>
                        <div id="toptags" class="sidebar-item">
                        </div>
                    </div>
                    <div>
                        <h4>Top contributors</h4>
                        <div id="topcontributors" class="sidebar-item">
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <hr />
    </div>
    <footer>
        <center>
            &copy; Madhusoodan P
        </center>
    </footer>

</body>

</html>