<!DOCTYPE html>
<html lang="en" ng-app="inodes">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>i-nodes</title>
    <link rel="stylesheet" href="./index.css">
    <!-- <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script> -->
    <script src="/common.js"></script>
    <script>
        class INodes {
            constructor() {
                let self = this;
                this.klassPromises = {}
                this.scriptPromises = {}
                this.pageSize = 10;
                this.pageNum = 0;
                get('/klasses').then(function (data) {
                    self.populateClassTypes(JSON.parse(data.response));
                })
                this.setupSearch();
                this.populateTopTags();
                this.showUserInfo();
            }
            setupSearch() {
                let q = new URL(window.location.href).searchParams.get("q")
                c('searchbox').value = q
                console.log(q)
                this.doSearch(q)
            }
            populateTopTags() {
                let self = this;
                get('/trendingTags').then(d => {
                    let dd = g('toptags')
                    let tags = [];
                    let resp = JSON.parse(d.response)
                    Object.keys(resp).forEach(k => tags.push({ item: k, hits: resp[k] }))
                    tags.sort((a, b) => b.hits - a.hits);
                    tags.forEach(tag => {
                        dd.appendChild(self.createTagElement(tag.item, '#', tag.hits))
                        dd.appendChild(document.createElement('br'))
                    })
                })
            }
            populateClassTypes(data) {
                let select = g('kclasses');
                select.addEventListener('change', e => this.klassChanged(e.target.value));
                data.forEach(klassName => {
                    select.innerHTML += `<option name='${klassName}'>${klassName}</option>`
                });
                this.klasses = {}
                this.klassChanged(data[0])
            }
            loadKlass(klassName) {
                if (this.klassPromises[klassName]) {
                    return this.klassPromises[klassName];
                }
                let self = this;
                this.klassPromises[klassName] = new Promise((resolve, reject) => {
                    if (self.klasses[klassName]) {
                        return resolve(self.klasses[klassName]);
                    }
                    get(`/klass/${klassName}`).then(d => {
                        self.klasses[klassName] = JSON.parse(d.response);
                        resolve(self.klasses[klassName])
                    })
                });
                return this.klassPromises[klassName]
            }
            klassChanged(klassName) {
                let self = this;
                this.currentClass = klassName;
                this.loadKlass(klassName).then(d => {
                    this.renderInput(d)
                });
            }
            loadScript(path, callBack) {
                return new Promise((resolve, reject) => {
                    var jsElm = document.createElement("script");
                    jsElm.type = "application/javascript";
                    jsElm.src = path;
                    jsElm.addEventListener('load', e => resolve())
                    document.body.appendChild(jsElm);
                });
            }
            loadCss(path, callBack) {
                return new Promise((resolve, reject) => {
                    var fileref = document.createElement("link");
                    fileref.rel = "stylesheet";
                    fileref.type = "text/css";
                    fileref.href = path;
                    fileref.addEventListener("load", e => resolve())
                    document.getElementsByTagName("head")[0].appendChild(fileref)
                })
            }
            loadKlassScripts(klass) {
                let name = klass.name
                if (this.scriptPromises[name]) {
                    return this.scriptPromises[name]
                }
                this.scriptPromises[name] = new Promise((resolve, reject) => {
                    if (klass.obj) {
                        return resolve(klass.obj)
                    }
                    let proms = [];
                    klass.jsPaths.forEach(s => proms.push(this.loadScript(s)))
                    klass.cssPaths.forEach(s => proms.push(this.loadCss(s)))
                    Promise.all(proms).then(x => {
                        let k = eval(klass.name)
                        klass.obj = new k();
                        resolve(klass.obj)
                    });
                })
                return this.scriptPromises[name]
            }
            renderInput(klass, obj) {
                let self = this;
                this.loadKlassScripts(klass).then(klassObj => {
                    let e = g('editor');
                    e.innerHTML = '';
                    if (!klass.editor || obj) {
                        klass.editor = klassObj.getEditor(obj)
                    }
                    e.appendChild(klass.editor)
                });
            }
            loggedIn() {
                return getCookie(USER_KEY)
            }
            showUserInfo() {
                if (this.loggedIn()) {
                    g('actions').innerHTML = `
                        <a class="action-item" href="javascript:inodes.openEditor()">New Post</a>
                        <a class="action-item" href="javascript:inodes.openAccount()">Account</a>
                        <a class="action-item" href="javascript:inodes.openMyPosts()">My Posts</a>
                        <a class="action-item" href="javascript:inodes.logout()">Logout</a>
                    `;
                } else {
                    g('actions').innerHTML = `
                        <a class="action-item" href="javascript:inodes.openSignInPage()">Sign In</a>
                        <a class="action-item" href="javascript:inodes.openRegisterPage()">Sign Up</a>
                    `
                }
            }
            openSignInPage() {
                this.triggerSearch('#inodesapp #login')
            }
            post() {
                let self = this;
                post(
                    '/data',
                    {
                        content: JSON.stringify(this.klasses[this.currentClass].obj.getContent()),
                        type: this.currentClass,
                        tags: g('tags-editor').value.split(/\s+/),
                        visibility: g('private-post').checked ? getCurrentUser() : "public"
                    },
                    {
                        "Content-Type": "application/json"
                    }
                ).then(e => alert('Done'))
                    .catch((code) => {
                        if (code == 401) {
                            self.showUserInfo()
                        }
                    })
            }
            doSearch(str, offset = 0, pageSize = 10) {
                this.search(str, offset, pageSize).then(d => {
                    this.results = JSON.parse(d.response)
                    this.showResults();
                })
            }
            search(str, offset = 0, pageSize = 10) {
                str = str ? str : ""
                str = str.replace(/\!\w+/, "")
                return get(`/data?q=${encodeURIComponent(str)}&offset=${offset}&pageSize=${pageSize}`)
            }
            showResults() {
                let d = g('posts');
                d.innerHTML = ''
                let self = this
                let proms = []
                this.results.results.forEach(r => {
                    proms.push(self.showCard(d, r));
                })
                Promise.all(proms).then(() => {
                    if (this.results.results.length < this.results.totalResults) {
                        d.appendChild(this.getPaginationItem(this.results));
                    }
                });
            }
            getSearchQuery() {
                return c('searchbox').value;
            }
            getPaginationItem(results) {
                let self = this;
                let resp = function () {
                    let container = {
                        ele: 'div',
                        classList: 'pages',
                        children: []
                    }
                    for (let i = 0; i < results.totalResults; i += self.pageSize) {
                        container.children.push(
                            {
                                ele: 'span',
                                classList: `page-btn ${(i / self.pageSize) == self.pageNum ? "selected" : ""}`,
                                text: i / self.pageSize + 1,
                                evnts: {
                                    click: function (e) {
                                        self.pageNum = i / self.pageSize
                                        self.doSearch(self.getSearchQuery(), i, self.pageSize)
                                    }
                                }
                            }
                        )
                    }
                    return container;
                }
                return render('paginator', resp());
            }
            deleteInode(id) {
                if (!this.loggedIn()) {
                    alert('Login to delete content')
                    return
                }
                delet(`/data/${id}`).then(e => alert('Done')).catch(c => {
                    if (c == 401) {
                        alert(`You are unauthorized to delete ${id}`)
                    }
                });
            }
            editInode(obj) {
                if (!this.loggedIn()) {
                    alert('Login to post / update content')
                    return
                }
                this.renderInput(this.klasses[obj.type], obj)
                g('tags-editor').value = obj.tags.join(' ')
                this.openEditor()
            }
            downvoteInode(id) {
                post(
                    `/posts/downvote/${id}`,
                    {}
                ).then(a => alert('Done'));
            }
            upvoteInode(id) {
                post(
                    `/posts/upvote/${id}`,
                    {}
                ).then(a => alert('Done'));
            }
            showCard(d, r) {
                let self = this;
                let template = function (s, obj) {
                    let card;
                    try {
                        card = s.getCard(r)
                    } catch (e) {
                        card = render('inodes', {
                            ele: 'pre',
                            styles: {
                                width: "95%",
                                'background-color': 'red',
                                color: 'white',
                                padding: "10px"
                            },
                            text: `Error while processing \n${JSON.stringify(obj, null, '\t')}\n\nException: \n${e}`
                        })
                    }
                    return {
                        ele: 'div',
                        classList: 'container',
                        styles: {
                            borderLeft: `solid 3px ${self.randColor()}`,
                            position: 'relative'
                        },
                        children: [
                            {
                                preBuilt: true,
                                ele: card
                            },
                            {
                                ele: 'div',
                                classList: 'tag-owner',
                                children: [
                                    {
                                        ele: 'div',
                                        classList: 'tag-actions',
                                        children: [
                                            {
                                                preBuilt: true,
                                                ele: self.getTagsElement(r.tags, r.owner, r.type)
                                            },
                                            {
                                                ele: 'div',
                                                classList: 'actions',
                                                children: [
                                                    {
                                                        ele: 'span',
                                                        text: `&#x25B2 ${obj.votes || 0}`,
                                                        classList: 'action-upvote',
                                                        evnts: {
                                                            click: function (e) { self.upvoteInode(obj.id) }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        text: `&#x25BC`,
                                                        classList: 'action-downvote',
                                                        evnts: {
                                                            click: function (e) { self.downvoteInode(obj.id) }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        text: 'edit',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { self.editInode(obj) }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        text: 'delete',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { self.deleteInode(obj.id) }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        text: 'comment(s)',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { self.commentInode(obj) }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        text: 'share',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { window.location = `?q=@${obj.id}` }
                                                        }
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                    ,
                                    {
                                        ele: 'div',
                                        classList: 'user-time',
                                        children: [
                                            {
                                                ele: 'span',
                                                classList: 'postowner',
                                                text: `${obj.owner}`,
                                                evnts: {
                                                    click: function (e) {
                                                        self.searchUser(obj.owner);
                                                    }
                                                }
                                            },
                                            {
                                                ele: 'span',
                                                classList: 'posttime',
                                                text: `${self.getLocalTime(obj.postTime)}`
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                ele: 'div',
                                classList: 'comments-pane',
                                attribs: {
                                    id: `comment-pane-${obj.id}`
                                },
                                children: [
                                    {
                                        ele: 'div',
                                        children: [
                                            {
                                                ele: 'textarea',
                                                attribs: {
                                                    id: `comment-${obj.id}`,
                                                    rows: 2
                                                },
                                                styles: {
                                                    width: '90%'
                                                }
                                            },
                                            {
                                                ele: 'button',
                                                text: 'Post',
                                                styles: {
                                                    width: '8%',
                                                    height: '40px'
                                                },
                                                evnts: {
                                                    click: function (e) {
                                                        post(
                                                            `/posts/comment/${obj.id}`,
                                                            g(`comment-${obj.id}`).value
                                                        )
                                                    }
                                                }
                                            }
                                        ]
                                    },
                                    {
                                        ele: 'div',
                                        attribs: {
                                            id: `oldcomments-${obj.id}`
                                        }
                                    }
                                ]
                            }
                        ]
                    };
                }
                return new Promise(function (resolve, reject) {
                    self.loadKlass(r.type).then(klass => {
                        self.loadKlassScripts(klass).then(s => {
                            d.appendChild(render('inode', template(s, r)));
                            resolve()
                        })
                    })
                });
            }
            searchUser(user) {
                this.triggerSearch(`#user !${user}`)
            }
            commentInode(obj) {
                g(`comment-pane-${obj.id}`).style.display = "block";
                let container = g(`oldcomments-${obj.id}`);
                container.innerHTML = ""
                get(`/posts/comments/${obj.id}`).then(comments => {
                    comments = JSON.parse(comments.response)
                    comments.sort((a, b) => a.time - b.time).forEach(comment => {
                        let c = document.createElement('div')
                        c.classList = "inode-comment-card"
                        c.innerHTML = `${JSON.parse(comment.comment)} - <a href="javascript:inodes.searchUser('${comment.user}')">${comment.user}</a>`
                        container.appendChild(c)
                    })
                })
            }
            getLocalTime(ep) {
                var d = new Date(ep);
                //d.setUTCSeconds(ep);
                return d.toLocaleDateString()
            }
            randColor() {
                var letters = '0123456789ABCDEF';
                var color = '#';
                for (var i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }
            getTagsElement(tags, user, type) {
                let x = document.createElement('div')
                x.classList = "tags-container"
                if (!tags) return x;
                let self = this;
                tags.forEach(tag => {
                    x.appendChild(this.createTagElement(tag, '#'));
                });
                user && x.appendChild(this.createTagElement(user, '~'))
                type && x.appendChild(this.createTagElement(type, '%'))
                return x;
            }

            createTagElement(tag, char, hits) {
                let self = this;
                let t = document.createElement('span');
                t.innerHTML = `<span class='tag'>${hits ? "" : char}${tag}</span>`
                if (hits) {
                    t.innerHTML += `<span style="color: gray; font-size: 0.8em"> x ${hits}</span>`
                }
                t.addEventListener('click', e => {
                    let q = ""
                    if (e.ctrlKey) {
                        q = c('searchbox').value + " "
                    }
                    q += `${char}${tag}`
                    c('searchbox').value = q.trim()
                    self.doSearch(q)
                })
                return t;
            }
            openEditor() {
                g('editor-pane').style.display = 'block';
            }
            closeEditor() {
                g('editor-pane').style.display = 'none';
            }
            logout(e) {
                post(
                    '/auth/logout',
                    {},
                    { 'Content-Type': 'application/json' }
                )
                eraseCookie(USER_KEY)
                eraseCookie(TOK_KEY)
                this.showUserInfo()
                this.authStatus('logged out successfully', 'green')
            }
            register() {
                post(
                    '/auth/register',
                    {
                        user: c('usernamebox').value,
                        password: c('passwordbox').value
                    },
                    {
                        'Content-Type': 'application/json'
                    }
                ).then(() => {
                    this.authStatus('registration successful. refer some existing user to verify you', 'green')
                }).catch(() => {
                    this.authStatus('registration failed', 'red')
                })
            }
            triggerSearch(q) {
                c('searchbox').value = q;
                this.doSearch(q)
            }
            openAccount() {
                let u = getCurrentUser();
                if (u) {
                    this.triggerSearch(`#user !${u}`)
                } else {
                    alert('Login first')
                }
            }
            openMyPosts() {
                let u = getCurrentUser();
                if (u) {
                    this.triggerSearch(`~${u}`)
                } else {
                    alert('Login first')
                }
            }
            openRegisterPage() {
                this.triggerSearch('#register #inodesapp')
            }

            runCommand(scriptText, pnode) {

                if (!pnode) {
                    pnode = document.createElement('div');
                }
                pnode.innerHTML = ''

                let status = document.createElement('status')
                status.style = "display: block"
                pnode.appendChild(status);

                let out = document.createElement('pre');
                out.style = "background-color: black; color: white; width: 100%; height: 200px; overflow: auto"
                pnode.appendChild(out);


                let ajax = function (method, url, data, hdrs) {
                    return new Promise((resolve, reject) => {
                        var xhttp = new XMLHttpRequest();
                        xhttp.onreadystatechange = function () {
                            if (this.readyState == 4 && this.status == 200) {
                                resolve({ response: this.responseText })
                            }
                            if (this.status == 401) {
                                reject(401);
                            }
                        };
                        xhttp.open(method, url, true);
                        hdrs && Object.keys(hdrs).forEach(key => xhttp.setRequestHeader(key, hdrs[key]))
                        xhttp.send(data);
                    });
                }
                let post = function (url, data, hdrs) {
                    return ajax('POST', url, JSON.stringify(data), hdrs);
                }

                post(
                    'http://inedctst01:5000/cli',
                    { script: scriptText },
                    { 'Content-Type': 'application/json' }
                ).then(d => {
                    d = d.response
                    status.innerHTML = `<b style="color:blue">Starting</b>`
                    var source = new EventSource(`http://inedctst01:5000/poll?rid=${d}`);
                    source.onmessage = function (event) {
                        status.innerHTML = `<b style="color:orange">Running</b>`
                        if (event.data == 'MPATAKI-STOP_EVENT-SOURCE') {
                            status.innerHTML = `<b style="color:green">Done</b>`
                            event.target.close()
                            return
                        }
                        out.innerHTML += event.data + "<br/>"
                    }
                })
            }

        }

        function render(name, spec, elemCreated, container) {
            let e;
            if (!spec.preBuilt) {
                e = document.createElement(spec.ele);
                spec.iden && elemCreated(spec.iden, e)
                if (spec.text) e.innerHTML = spec.text;
                if (spec.classList) {
                    e.classList = `${name}-` + spec.classList.split(/\s+/).join(` ${name}-`)
                }
                spec.attribs && Object.keys(spec.attribs).forEach(key => {
                    e[key] = spec.attribs[key]
                })
                spec.styles && Object.keys(spec.styles).forEach(key => {
                    e.style[key] = spec.styles[key]
                })
                spec.evnts && Object.keys(spec.evnts).forEach(key => {
                    e.addEventListener(key, spec.evnts[key])
                })
                if (spec.children) {
                    if (spec.children instanceof Function) {
                        spec.children().map(x => e.appendChild(x))
                    }
                    else spec.children.forEach(child => render(name, child, elemCreated, e))
                }
            } else {
                e = spec.ele;
            }
            if (container) {
                container.appendChild(e)
                if (spec.label) {
                    let rgid = "id_" + Math.random();
                    e.id = rgid
                    let lbl = document.createElement('label')
                    lbl.innerHTML = spec.label
                    lbl.for = rgid
                    container.appendChild(lbl)
                }
                return container;
            }
            return e;
        }

        let inodes;
        window.addEventListener('load', () => {
            inodes = new INodes();
        });
    </script>

</head>

<body>
    <div class="content">
        <div class="top">
            <span class="title">i-nodes</span>
        </div>
        <div id="editor-pane">
            <fieldset>
                <span onclick="inodes.closeEditor()" class="closebtn">x</span>
                <label for="kclasses" class="">Post type: </label><br />
                <select id="kclasses"></select><br /><br />
                <label for="editor">Post editor</label><br />
                <div id="editor"></div><br />
                <label for="tags-editor">Tags</label><br />
                <input type="text" id="tags-editor"></input>
                <span class="private-post-panel"><input type="checkbox" id="private-post">private</input></span>
                <br /><br />
                <button onclick="inodes.post()">Submit</button>
            </fieldset>
        </div>
        <div class="ppane">
            <span id="server-messages"></span>
            <div class="search-pane">
                <input type="text" placeholder="search" class="searchbox" oninput="inodes.doSearch(this.value)" />
            </div>
            <div class="posts-trending">
                <div class="left-w85">
                    <div class="posts-container">
                        <div id="posts"></div>
                    </div>
                </div>
                <div class="right-w15">
                    <div>
                        <h4>Actions</h4>
                        <div id="actions" class="actions sidebar-item"></div>
                    </div>
                    <div>
                        <h4>Top tags</h4>
                        <div id="toptags" class="sidebar-item">
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <footer>
        <hr />
        <center>
            &copy; Madhusoodan P
        </center>
    </footer>

</body>

</html>