<!DOCTYPE html>
<html lang="en" ng-app="inodes">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>i-nodes</title>
    <link rel="stylesheet" href="./index.css">
    <script src="/common.js"></script>
    <script src="/squirrelly.min.js"></script>
    <script src="./tagify.min.js"></script>
    <link rel="stylesheet" href="./tagify.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
        integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script>

        class ITag {
            constructor(container, app, tag, char, hits) {
                let self = this
                render('tag', {
                    ele: 'span',
                    classList: 'has-tooltip',
                    children: [
                        {
                            ele: 'span',
                            classList: 'container',
                            children: [
                                { ele: 'span', text: (hits ? "" : char) + tag }
                            ]
                        },
                        ...(hits ? [{ ele: 'span', classList: 'hits', text: ` x ${hits}` }] : []),
                        {
                            ele: 'div',
                            classList: 'tooltip',
                            children: [
                                {
                                    ele: 'div',
                                    classList: 'tt-title-container',
                                    children: [
                                        {
                                            ele: 'b',
                                            classList: 'tt-title',
                                            text: tag
                                        },
                                        ...(char == '#' ? [] : [
                                            {
                                                ele: 'span', text: ' (pseudo tag)', attribs: { style: 'font-size: 0.8em;' }
                                            }
                                        ]),
                                    ]
                                },
                                {
                                    ele: 'div',
                                    classList: 'desc'
                                },
                                ...(char == '#' ? [{
                                    ele: 'div',
                                    children: [
                                        ...(app.loggedIn() ? [{
                                            ele: 'span',
                                            text: 'watch',
                                            classList: 'tt-btn',
                                            evnts: {
                                                click: function () {
                                                    app.subscribe('TAG', tag, 'ALL')
                                                }
                                            }
                                        }] : []
                                        ),
                                        {
                                            ele: 'span', text: 'view', classList: 'tt-btn', evnts: { click: _ => app.viewTag(tag) }
                                        }
                                    ]
                                }] : []
                                )
                            ],
                            evnts: { click: e => e.stopPropagation() }
                        }
                    ],
                    evnts: {
                        click: e => {
                            let q = `${char}${tag}`
                            if (e.ctrlKey) {
                                q += " " + app.getSearchQuery()
                            }
                            app.search(q)
                        },
                        mouseenter: function (e) {
                            this.setAttribute('data-intime', +new Date());
                            let ltim = setTimeout(_ => {
                                let lt = this.getAttribute('data-intime');
                                if (!lt) return;
                                lt = +lt;
                                let ttc = this.querySelector('.tag-tooltip');
                                let tt = this.querySelector('.tag-desc');
                                if (!tt.getAttribute('desc-resolved')) {
                                    self.getTagToolTip(tag, char, app).then(x => {
                                        tt.appendChild(x);
                                        tt.setAttribute('desc-resolved', true)
                                    })
                                }
                                ttc.style.visibility = 'visible';
                            }, 600)
                            this.setAttribute('ltimer', ltim)
                        },
                        mouseleave: function () {
                            this.querySelector('.tag-tooltip').style.visibility = 'hidden'
                            this.setAttribute('data-intime', undefined);
                            clearTimeout(this.getAttribute('ltimer'))
                        }
                    }
                }, _ => _, container)
                if (hits)
                    container.appendChild(document.createElement('br'))
            }

            getTagToolTip(tag, char, app, hits) {
                if (!this._tagCache) {
                    this._tagCache = {};
                }
                let tagCache = this._tagCache;
                return new Promise((resolve, reject) => {
                    let dprom;
                    if (char != '#') {
                        dprom = new Promise((res, rej) => {
                            res({
                                ele: 'span',
                                classList: 'desc',
                                text: char != '%' ? `Content created by ${tag}` : `Content of type ${tag}`
                            })
                        })
                    } else {
                        dprom = new Promise((res, rej) => {
                            if (tagCache[tag]) {
                                return res(tagCache[tag])
                            }
                            app.getTag(tag).then(r => {
                                tagCache[tag] = {
                                    ele: 'div', children: [
                                        {
                                            ele: 'div', classList: 'doccount',
                                            text: `${Object.values(r.extra.docCount).reduce((x, z) => x + z, 0)} doc(s)`
                                        },
                                        {
                                            ele: 'span', classList: 'desc',
                                            text: r.basic.description || "No description avaialable. Edit and add a description"
                                        }
                                    ]
                                }
                                res(tagCache[tag])
                            })
                        })
                    }
                    dprom.then(x => {
                        resolve(render('tag-ttc', x))
                    })
                })
            }
        }

        class LargeInode {

            constructor(rc, app, obj) {

                function getTagsElement(tags, user, type, app) {
                    let x = document.createElement('div')
                    x.classList = "tags-container"
                    if (tags) {
                        tags.forEach(tag => new ITag(x, app, tag, '#'))
                        user && (new ITag(x, app, user, '~'))
                        type && (new ITag(x, app, type, '%'))
                    }
                    return x;
                }

                function getContextButtons(klass, obj) {
                    let self = this;
                    let getLockIcon = _ => obj.visibility != 'g-public' ? [{ ele: 'span', html: '&#128274;', attribs: { title: 'Private (only visible to you)' } }] : []
                    return {
                        ele: 'div',
                        classList: 'context-btns',
                        children: [
                            { ele: 'span', attribs: { title: 'pin', innerHTML: '&#128204;' }, evnts: { click: e => pinItem(e.target, obj) } },
                            { ele: 'span', attribs: { title: 'unpin', innerHTML: '&#128204;' }, styles: { display: "none", 'text-decoration': 'line-through', 'text-decoration-thickness': '3px' }, evnts: { click: function (e) { unpinItem(this, obj); } } },
                            ...getLockIcon(),
                            {
                                ele: 'span',
                                classList: 'context-btn',
                                html: '&#x26F6;',
                                attribs: { title: 'Full screen' },
                                evnts: {
                                    click: e => makeFullScreen(e.target.parentNode.nextSibling.childNodes[0])
                                }
                            }
                        ]
                    }
                }

                let pinItem = (ele, obj) => {
                    app.pin(obj.id, ele.parentNode.parentNode)
                    ele.style.display = 'none'
                    ele.nextSibling.style.display = 'inline-block'
                }

                let unpinItem = (ele, obj) => {
                    app.unpin(obj.id, ele.parentNode.parentNode)
                    ele.style.display = 'none'
                    ele.previousElementSibling.style.display = 'inline-block'
                }

                let template = (klass, obj) => {
                    let card;
                    try {
                        if (obj.needsApproval && app.currentUid() != obj.owner) {
                            card = klass.getSafeCard(obj);
                        } else {
                            if (obj.content == '') {
                                klass = new NoPermissionKlass()
                            }
                            card = klass.getCard(obj)
                        }
                    } catch (e) {
                        card = render('inodes', {
                            ele: 'pre', classList: 'error',
                            text: `Error while processing \n${JSON.stringify(obj, null, '\t')}\n\nException: \n${e}\n${e.stack}`
                        })
                    }

                    return {
                        ele: 'div',
                        classList: 'container',
                        styles: {
                            borderLeft: `solid 4px ${randColor()}`,
                            position: 'relative',
                            display: 'flex',
                            'flex-direction': 'column'
                        },
                        children: [
                            getContextButtons(klass, obj),
                            {
                                ele: 'div',
                                classList: 'container-parent',
                                children: [
                                    {
                                        preBuilt: true,
                                        ele: card
                                    }
                                ]
                            },
                            {
                                ele: 'div',
                                classList: 'tag-owner-actions',
                                children: [
                                    {
                                        ele: 'div',
                                        classList: 'tag-owner',
                                        children: [
                                            {
                                                preBuilt: true,
                                                ele: getTagsElement(obj.tags, obj.owner, obj.type, app)
                                            },
                                            {
                                                ele: 'div',
                                                classList: 'user-time',
                                                styles: { float: 'right' },
                                                children: [
                                                    {
                                                        ele: 'span',
                                                        classList: 'postowner',
                                                        text: `${obj.owner}`,
                                                        evnts: {
                                                            click: _ => app.searchUser(obj.owner)
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        classList: 'posttime',
                                                        styles: {
                                                            'font-size': '0.7em'
                                                        },
                                                        text: `${new Date(obj.postTime).toDateString()}`
                                                    }
                                                ]
                                            },

                                        ]
                                    },
                                    {
                                        ele: 'div',
                                        classList: 'actions-list',
                                        children: [
                                            {
                                                ele: 'div',
                                                classList: 'actions',
                                                children: [
                                                    {
                                                        ele: 'span',
                                                        html: `&#x25B2 ${obj.votes || 0}`,
                                                        classList: 'action-upvote',
                                                        evnts: { click: _ => app.upvoteInode(obj.id) }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        html: `&#x25BC`,
                                                        classList: 'action-downvote',
                                                        evnts: { click: _ => app.downvoteInode(obj.id) }
                                                    },
                                                    ...(!app.loggedIn() ? [] : [{
                                                        ele: 'span',
                                                        text: 'edit',
                                                        classList: 'action',
                                                        evnts: { click: _ => app.editInode(obj) }
                                                    }]),
                                                    ...(!app.loggedIn() ? [] : [{
                                                        ele: 'span',
                                                        text: 'delete',
                                                        classList: 'action',
                                                        evnts: { click: _ => app.deleteInode(obj.id) }
                                                    }]),
                                                    {
                                                        ele: 'span',
                                                        text: 'comment(s)',
                                                        classList: 'action',
                                                        evnts: { click: _ => this.openComments(obj) }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        text: 'share',
                                                        classList: 'action share-has-tooltip',
                                                        evnts: {
                                                            mouseenter: function (e) { this.children[0].style.display = 'block' },
                                                            mouseleave: function (e) { this.children[0].style.display = 'none' }
                                                        },
                                                        children: [
                                                            {
                                                                ele: 'div', classList: 'share-tooltip', children: [
                                                                    {
                                                                        ele: 'b', text: 'copy ', children: [
                                                                            { ele: 'a', attribs: { href: app.getPermalink(obj.id), target: '_blank' }, text: 'url' }
                                                                        ]
                                                                    },
                                                                    {
                                                                        ele: 'div', children: [
                                                                            { ele: 'input', attribs: { readOnly: true, value: app.getPermalink(obj.id), style: 'width: 180px' } },
                                                                            {
                                                                                ele: 'button', text: 'copy', evnts: {
                                                                                    click: function () { copyFormatted(this.previousElementSibling.value) }
                                                                                }
                                                                            }
                                                                        ]
                                                                    },
                                                                    ...(!klass.getCopyContent ? [] : [
                                                                        { ele: 'b', styles: { display: 'block', 'margin-top': '10px' }, text: 'or copy the content' },
                                                                        {
                                                                            ele: 'button',
                                                                            text: 'copy content',
                                                                            evnts: {
                                                                                click: _ => copyFormatted(klass.getCopyContent(obj)),
                                                                                rendered: e => e.removeAttribute('tabindex')
                                                                            }
                                                                        }
                                                                    ])
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    ...(!app.loggedIn() ? [] : [{ ele: 'span', text: 'watch', classList: 'action', evnts: { click: _ => app.watchDoc(obj.id) } }])
                                                ]
                                            },
                                            {
                                                ele: 'div',
                                                classList: 'actions',
                                                styles: { float: 'right' },
                                                children: [
                                                    { ele: 'span', classList: 'action', text: 'history', evnts: { click: _ => app.openHistory(obj.id) } },

                                                    ...(!app.loggedIn() ? [] : [{ ele: 'span', classList: 'action', text: 'flag', evnts: { click: _ => app.flagInode(obj.id) } }]),

                                                    ...(!obj.needsApproval ? [] : [{ ele: 'span', classList: 'action', text: 'approve', evnts: { click: () => app.approveInode(obj.id) } }]),

                                                    ...(app.loggedIn() != 'admin' ? [] : [{ ele: 'span', text: 'trust', classList: 'action', evnts: { click: _ => app.trustInode(obj.id) } }])
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                ele: 'div',
                                classList: 'comments-pane',
                                iden: 'commentsSection',
                                children: [
                                    {
                                        ele: 'div',
                                        styles: {
                                            display: 'flex',
                                            marginBottom: '10px'
                                        },
                                        children: [
                                            {
                                                ele: 'textarea',
                                                attribs: {
                                                    iden: 'commentarea',
                                                    rows: 2
                                                },
                                                styles: {
                                                    width: '90%',
                                                    border: 'solid 1px gray',
                                                    resize: 'none'
                                                }
                                            },
                                            {
                                                ele: 'button',
                                                text: 'Post',
                                                styles: {
                                                    width: '10%'
                                                },
                                                evnts: {
                                                    click: _ => {
                                                        app.comment(obj.id, _.target.previousElementSibling.value)
                                                            .then(x => this.addCommentToList(x.json))
                                                            .catch(e => showError(e.message))
                                                    }
                                                }
                                            }
                                        ]
                                    },
                                    { ele: 'div', classList: 'oldcomments', iden: 'comments' }
                                ]
                            }
                        ]
                    }
                }

                if (!obj.type || obj.type == "") {
                    rc.appendChild(render('inode', template(undefined, obj)));
                    return;
                }
                return app.getKlass(obj.type).then(klass => {
                    render('inode', template(klass, obj), (k, e) => this[k] = e, rc)
                })
            }

            openComments(obj) {
                this.commentsSection.style.display = "block";
                let container = this.comments;
                container.innerHTML = ""
                get(`/posts/comments/${obj.id}`).then(comments => {
                    comments = JSON.parse(comments.response)
                    comments.sort((a, b) => a.time - b.time).forEach(comment => {
                        this.addCommentToList(comment)
                    })
                })
            }

            addCommentToList(c) {
                render('inode-comment', {
                    ele: 'div', classList: 'card',
                    children: [
                        { ele: 'span', html: JSON.parse(c.txt).replaceAll(/@([0-9A-Za-z]+)/g, '<a href="/?q=%23inodesapp%20%23viewuser !$1" target="_blank" >$1</a>') },
                        { ele: 'span', html: ` - <a href="/?q=%23inodesapp%20%23viewuser !${c.userid}">${c.userid}</a>` },
                        ...(
                            c.userid != app.currentUid() ? [] : [
                                { ele: 'span', text: 'delete', classList: 'action-btn', evnts: { click: _ => app.deleteComment(`${c.postid}/${c.userid}/${c.itime}`).then(_.target.parentNode.remove()) } }
                            ]
                        )
                    ]
                }, 0, this.comments)
            }
        }

        class Facets {
            constructor(facets, container, title, char, app) {
                render('facets', {
                    ele: 'div', iden: 'tagsEle',
                    children: [
                        { ele: 'h4', text: title },
                    ]
                }, (k, e) => this[k] = e, container)
                Object.keys(facets)
                    .filter(k => facets[k] > 0)
                    .map(k => ({ item: k, hits: facets[k] }))
                    .sort((a, b) => b.hits - a.hits)
                    .forEach(tag => new ITag(this.tagsEle, app, tag.item, char, tag.hits))
            }
        }

        class Searcher {

            /**
             * sb : search bar container
             * rc : result container
             * inodes : service provider
             * 
             * options:
             *  size: mini, large
             *  defQuery : default query
             *  pageSize : a page size which is used in the query
             *  sorter : a function to sort the results in UI (homepage, etc.)
             *  searchBarEle : if you have 
             */
            constructor(resultContainer, app, options) {

                let { searchInput, size, defQuery, pageSize, sorter, facetsEle } = options
                this.app = app
                this.offset = 0
                this.pinned = {}
                this.options = options

                /* setup search bar and events */
                this.sb = searchInput
                if (!this.sb) {
                    this.sb = document.createElement('input')
                    resultContainer.appendChild(this.sb)
                }
                this.sb.addEventListener('input', _ => this.search(_.target.value))

                /* setup results box */
                render('searcher', {
                    ele: 'div', classList: "posts-container", children: [
                        { ele: 'div', iden: 'pinned', classList: 'posts' },
                        { ele: 'div', iden: 'rc', classList: 'posts' },
                        { ele: 'div', iden: 'pages' }
                    ]
                }, (id, ele) => this[id] = ele, resultContainer)

                /* trigger a default search */
                this.search("")
            }

            search(str) {
                let { sb, rc, searchInput, size, defQuery, pageSize, sorter, app, offset } = { ...this, ...this.options };
                sb.value = str
                callWithWaitUI(rc, (done) => {
                    str = str == "" ? defQuery : str
                    app.getSearchResults(str, offset, pageSize || 10).then(d => {
                        let { results, facetResults, totalResults } = d.json

                        /* apply custom sorting */
                        if (sorter)
                            sorter(results)

                        if (results.length < 1) {
                            rc.innerHTML = '<div class="no-post-found">No posts found</div>'
                            return done()
                        }

                        this.showResults(results).finally(_ => done())
                        this.populateFacets(facetResults)
                    })
                })
            }

            populateFacets(facetResults) {
                const { app, facetsEle } = { ...this, ...this.options },
                    info = { 'tags': ['Tags', '#'], 'type': ['Post types', '%'], 'owner': ['Contributors', '~'] }
                facetsEle.innerHTML = ''
                let arr = ['type', 'tags', 'owner']
                arr.forEach(key => {
                    new Facets(facetResults[key], facetsEle, info[key][0], info[key][1], app)
                })
            }

            showResults(results) {
                let { sb, rc, searchInput, size, defQuery, pageSize, sorter, app, offset } = { ...this, ...this.options };
                let proms = [], itemsByClass = {}
                rc.innerHTML = ''

                results.forEach(r => {
                    if (this.pinned[r.id])
                        return
                    if (!itemsByClass[r.type]) {
                        itemsByClass[r.type] = []
                    }
                    itemsByClass[r.type].push(r)
                    proms.push(this.showCard(r))
                })

                return Promise.all(proms).then(_ => {
                    Object.keys(itemsByClass).forEach(key => {
                        app.getKlass(key).then(klass => {
                            if (klass.postDisplay)
                                klass.postDisplay(itemsByClass[key])
                        })
                    })
                })
            }

            showCard(r) {
                let { rc, size, app } = { ...this, ...this.options }
                if (size == 'min') {

                } else if (size == 'max') {
                    new LargeInode(rc, app, r)
                }
            }

            getSearchQuery() {
                return this.sb.value
            }

            pin(id, ele) {
                ele.remove(), this.pinned.appendChild(ele)
            }

            unpin(id, ele) {
                ele.remove(), this.rc.insertBefore(ele, this.rc.firstChild)
            }


            getPaginationItem(results) {
                let self = this;
                let resp = function () {
                    let container = {
                        ele: 'div',
                        classList: 'pages',
                        children: []
                    }
                    for (let i = 0; i < results.totalResults; i += self.pageSize) {
                        container.children.push(
                            {
                                ele: 'span',
                                classList: `page-btn ${(i / self.pageSize) == self.pageNum ? "selected" : ""}`,
                                text: i / self.pageSize + 1,
                                evnts: {
                                    click: function (e) {
                                        self.pageNum = i / self.pageSize
                                        self.doSearch(self.getSearchQuery(), i, self.pageSize)
                                    }
                                }
                            }
                        )
                    }
                    return container;
                }
                return render('paginator', resp());
            }
        }

        class Editor {
            constructor(obj, pane, app) {
                this.pane = pane, this.app = app
            }

            open(obj) {
                this.obj = obj
                this.pane.style.display = 'block'
                this.pane.innerHTML = ''
                render('editor', [
                    { ele: 'span', classList: 'closebtn', html: '&#x2715;', evnts: { click: _ => this.close() } },
                    {
                        ele: 'select', iden: 'typeSelector', label: 'Post type', attribs: { disabled: obj.id != undefined }, styles: { display: 'block', minWidth: '60%' }, evnts: {
                            rendered: e => this.app.getKlasses().then(x => {
                                e.innerHTML = Object.keys(x).map(k => `<option>${k}</option>`).join('')
                                e.value = obj.type || Object.keys(x)[0]
                                this.renderEditor(obj)
                            }),
                            change: _ => this.renderEditor(obj)
                        }
                    },
                    { ele: 'br' },
                    { ele: 'div', iden: 'editor' },
                    { ele: 'br' },
                    { ele: 'input', iden: 'tags', label: 'Tags: ', attribs: { placeholder: 'start typing a tag name. eg edc, hack', value: (obj.tags || []).join(' ') }, evnts: { rendered: e => tagify(e, 'tag') } },
                    { ele: 'br' },
                    {
                        ele: 'input', iden: 'visibility', label: 'Visibility: ', attribs: { placeholder: 'start typing a user or group name' }, evnts: {
                            rendered: e => {
                                let t = tagify(e, 'user')
                                let visibility = obj.id ? (obj.needsApproval ? obj.savedVisibility : obj.visibility) : ['g-public']
                                visibility = visibility.map(v => {
                                    return { name: v.substring(2), id: v, value: v, type: v[0] == 'g' ? 'group' : 'user' }
                                })
                                t.settings.whitelist.splice(0, visibility.length, ...visibility)
                                t.removeAllTags()
                                t.addTags(visibility)
                            }
                        }
                    },
                    { ele: 'br' },
                    ...(obj ? [{ ele: 'input', iden: 'changeNote', label: 'What id you change ', attribs: { placeholder: 'describe what changed in this version' } }] : []),
                    { ele: 'button', text: 'Post', evnts: { click: e => this.post(e) } }
                ], (k, e) => this[k] = e, this.pane)
            }

            close() {
                this.pane.style.display = 'none'
            }

            renderEditor(obj) {
                this.editor.innerHTML = ''
                this.app.getKlass(obj.type || this.typeSelector.value).then(klass => this.editor.appendChild(klass.getEditor(obj.id ? obj : undefined)))
            }

            post(e) {
                if (this.tags.value == '') { return showError('Tags are required for a post') }
                if (this.visibility.value == '') { return showError('Tags are required for a post') }
                if (this.obj && this.changeNote.value == '') { return showError('Please mention what changed in this post') }
                let obj = this.app.getKlass(this.typeSelector.value).then(editor => {
                    try {
                        post(`/data?changeNote=${encodeURIComponent(this.obj ? this.changeNote.value : "initial version")}`, {
                            content: JSON.stringify(editor.getContent()),
                            type: this.typeSelector.value,
                            tags: JSON.parse(this.tags.value).map(t => t.value).concat(editor.getTags ? editor.getTags() : []),
                            visibility: JSON.parse(this.visibility.value).map(u => u.value),
                            savedVisibility: this.obj.savedVisibility || ['none'],
                            id: this.obj.id
                        }).then(_ => showSuccess('Posted successfully'))
                            .then(_ => this.close())
                            .catch(e => showError(e.message))
                    } catch (err) {
                        showError(err)
                    }
                })
            }
        }

        class App {

            constructor(inodes) {

                function homePageSorter(results) {
                    function array_move(arr, old_index, new_index) {
                        if (new_index >= arr.length) {
                            var k = new_index - arr.length + 1;
                            while (k--) {
                                arr.push(undefined);
                            }
                        }
                        arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);
                        return arr;
                    }
                    for (let i = 0; i < results.length; i++) {
                        if (results[i].tags.includes('homepage'))
                            array_move(results, i, 0)
                    }
                }

                this.inodes = inodes
                this.searcher = new Searcher(c('left-w85'), this, {
                    searchInput: g('searchbox'),
                    size: 'max',
                    defQuery: new URL(window.location.href).searchParams.get("q") || "#homepage/*",
                    facetsEle: c('search-facets'),
                    sorter: homePageSorter
                })
                this.editor = new Editor({}, g('editor-pane'), this)

                this.showUserInfo()
            }

            logout() {
                inodes.logout().finally(_ => {
                    eraseCookie(USER_KEY)
                    eraseCookie(TOK_KEY)
                    showInfo("Logged out successfully")
                    this.showUserInfo()
                })
            }

            pin(id, ele) {
                this.searcher.pin(id, ele)
            }

            unpin(id, ele) {
                this.searcher.unpin(id, ele)
            }

            editInode(obj) {
                this.editor.open(obj)
            }

            watchDoc(id) {
                return this.subscribe('DOC', id, 'ALL')
            }

            getSearchQuery() {
                return this.searcher.getSearchQuery()
            }

            getSearchResults(x) {
                return this.inodes.search(x)
            }

            search(x) {
                return this.searcher.search(x)
            }

            refresh() {
                this.search(this.getSearchQuery())
            }

            currentUid() {
                return getCurrentUser();
            }

            loggedIn() {
                return this.currentUid() && true
            }

            comment(id, txt) {
                return this.inodes.comment(id, txt).catch(e => showError(e.message))
            }

            deleteComment(id) {
                return this.inodes.deleteComment(id).catch(e => showError(e.message))
            }

            subscribe(objtyp, objid, evnt) {
                return this.inodes.subscribe(objtyp, this.currentUid(), objid, evnt)
                    .then(e => showSuccess(`You have subscribed to ${objtyp} ${objid} for ${evnt} events`))
                    .catch(e => showError(e.message))
            }

            viewTag(tag) {
                return this.searcher.search(`#inodesapp #viewtag ${tag}`)
            }

            getTag(t) {
                return this.inodes.getTag(t)
            }

            approveInode(id) {
                return this.inodes.approveInode(id)
            }

            getPermalink(x) {
                return this.inodes.getPermalink(x)
            }

            trustInode(id) {
                post(`/trust/${id}`)
                    .then(r => showSuccess('Trusted'))
                    .catch(r => showError(r.message))
            }

            getKlass(kName) {
                return this.inodes.getKlass(kName)
            }

            getKlasses() {
                return this.inodes.getKlasses()
            }

            deleteInode(id) {
                if (!this.loggedIn()) return showError('Login to delete content')
                if (confirm('Are you sure to delete this content?'))
                    this.inodes.deleteInode(id)
                        .then(e => showSuccess(e.response))
                        .then(e => this.refresh())
                        .catch(c => showError(c))
            }

            openHistory(id) {
                this.search(`#inodesapp #history !${id}`)
            }

            flagInode(id) {
                this.inodes.flagInode(id)
                    .then(x => showSuccess('Flagged, a notification is sent to owner and security team'))
                    .catch(x => showError(x.message))
            }

            downvoteInode(id) {
                this.inodes.downvoteInode(id)
                    .then(a => showSuccess(a.response))
                    .catch(m => showError(m));
            }

            upvoteInode(id) {
                this.inodes.upvoteInode(id)
                    .then(a => showSuccess(a.response))
                    .catch(m => showError(m));
            }

            showUserInfo() {
                if (this.loggedIn()) {
                    c('title-right-panel').style.display = 'flex'
                    g('actions').innerHTML = ''
                    g('profilebtn').innerHTML = this.currentUid()
                    this.updateNotificationsCount();
                } else {
                    c('title-right-panel').style.display = 'none'
                    g('actions').innerHTML = `
                        <a class="action-item" href="javascript:app.openSigninPage()">Sign In</a>
                        <a class="action-item" href="javascript:app.openRegisterPage()">Sign Up</a>
                    `
                }
            }

            updateNotificationsCount() {
                get('/notifications/unseen').then(resp => {
                    let nc = +resp.response;
                    if (nc > 0) {
                        g('notifcount').style.display = 'block';
                        g('notifcount').innerHTML = nc;
                    } else {
                        g('notifcount').style.display = 'none';
                    }
                })
            }

            approveInode(docId) {
                this.inodes.approveInode(docId)
                    .then(x => showSuccess('Approved'))
                    .catch(x => showError(x.message))
            }

            searchUser(user) {
                this.search(`#inodesapp #viewuser !${user || this.currentUid()}`)
            }

            openMyPosts() {
                this.search(`~${this.currentUid()}`)
            }
            openNotifications() {
                this.search(`#inodesapp #notifications`)
            }
            openPRs() {
                this.search(`#inodesapp #mypermissionrequests`)
            }
            announceApp() {
                this.search(`#inodesapp #notifier`)
            }
            createGroup() {
                this.search("#inodesapp #creategroup")
            }
            openRegisterPage() {
                this.search('#inodesapp #register')
            }
            openSigninPage() {
                this.search('#inodesapp #login')
            }

            login(u, p) {
                post('/auth/login', {}, { 'Authorization': `Basic ${btoa(u + ":" + p)}` }).then((d) => {
                    let h = d.headers;
                    setCookie(USER_KEY, h['authinfo'].split(":")[0]);
                    setCookie(TOK_KEY, h['authinfo'].split(":")[1]);
                    showInfo("logged in successfully")
                    this.showUserInfo()
                    this.search("")
                }).catch(e => {
                    alert(`authentication failed. error: ${e}`)
                })
            }
        }

        class INodes {

            getKlass(kName) {
                return this.loadKlass(kName).then(kMeta => this.loadKlassScripts(kMeta))
            }

            getKlasses() {
                return this.klasses
            }

            constructor() {
                this.klassPromises = {}
                this.scriptPromises = {}
                this.pageSize = 10;
                this.pageNum = 0;
                post('/test-login').catch(() => this.logout())
                this.klasses = get('/klasses').then(x => x.json).then(a => a.reduce((m, o) => { m[o.name] = o; return m }, {}))
            }

            loadKlass(klassName) {
                return this.klasses.then(klasses => klasses[klassName])
            }

            loadScript(path, elem) {
                return new Promise((resolve, reject) => {
                    var jsElm = document.createElement("script");
                    jsElm.type = "application/javascript";
                    jsElm.src = path;
                    jsElm.addEventListener('load', e => resolve())
                    elem = elem || document.body
                    elem.appendChild(jsElm);
                });
            }

            comment(id, txt) {
                return post(`/posts/comment/${id}`, txt)
            }

            loadCss(path) {
                return new Promise((resolve, reject) => {
                    var fileref = document.createElement("link");
                    fileref.rel = "stylesheet";
                    fileref.type = "text/css";
                    fileref.href = path;
                    fileref.addEventListener("load", e => resolve())
                    document.getElementsByTagName("head")[0].appendChild(fileref)
                })
            }

            loadKlassScripts(klass) {
                let name = klass.name
                if (this.scriptPromises[name]) {
                    return this.scriptPromises[name]
                }
                this.scriptPromises[name] = new Promise((resolve, reject) => {
                    if (klass.obj) {
                        return resolve(klass.obj)
                    }
                    let proms = [];
                    klass.jsPaths.forEach(s => proms.push(this.loadScript(s)))
                    klass.cssPaths.forEach(s => proms.push(this.loadCss(s)))
                    Promise.all(proms).then(x => {
                        let k = eval(klass.name)
                        klass.obj = new k();
                        resolve(klass.obj)
                    });
                })
                return this.scriptPromises[name]
            }

            loggedIn() {
                return getCookie(USER_KEY)
            }

            search(str, offset = 0, pageSize = 10) {
                return getLast(`/data?q=${encodeURIComponent(str.replace(/\![-\w]+/, ""))}&offset=${offset}&pageSize=${pageSize}&fq=tags&fq=type&fq=owner`)
            }

            getPermalink(id) {
                let u = new URL(window.location.href)
                return `${u.protocol}//${u.host}?q=@${id}`
            }

            deleteInode = id => delet(`/data/${id}`)
            downvoteInode = id => post(`/posts/downvote/${id}`)
            upvoteInode = id => post(`/posts/upvote/${id}`)
            approveInode = id => post(`/data/${id}/approve`)
            flagInode = id => post(`/data/${id}/flag`)
            deleteComment = id => delet(`/posts/comment/${id}`)
            getTag = t => get(`/tags/${t}`).then(r => r.json)
            subscribe = (objtyp, uid, tag, evnt) => post(`/subscribe?subscriberType=USER&subscriberId=${uid}&objTyp=${objtyp}&objId=${tag}&event=${evnt}`)

            logout(e) {
                return post('/auth/logout')
            }

            register() {
                post('/auth/register', { user: c('usernamebox').value, password: c('passwordbox').value })
                    .then(() => showSuccess('registration successful. verify your email address by clicking on the link in the email sent to you'))
                    .catch(m => showError(`registration failed. reason: ${m}`))
            }


            lock() { this._lock = true }
            locked() { return this._lock }
            unlock() { this._lock = false }
        }

        class NoPermissionKlass {
            getCard(obj) {
                let noPermSpec = {
                    ele: 'div',
                    attribs: { style: 'padding: 50px' },
                    children: [
                        { ele: 'span', text: "You dont' have permissions to access this info. But you can " },
                        { ele: 'button', text: 'request', evnts: { click: () => { this.requestAccess(obj.id) } } },
                        { ele: 'span', text: " for it" }
                    ]
                };
                let permRequestedSpec = {
                    ele: 'div',
                    attribs: { style: 'padding: 50px' },
                    children: [
                        { ele: 'span', text: "Your request to get a permission on this object is still pending. You can track all your pending permission requests " },
                        { ele: 'a', text: 'here', attribs: { href: '/?q=%23inodesapp %23mypermissionrequests' } }
                    ]
                }
                return render('no-permission', obj.readState == 'PERM_REQUESTED' ? permRequestedSpec : noPermSpec)
            }
            getEditor() {
                throw new Error("You don't have permissions to edit this object")
            }
            requestAccess(id) {
                post(`/data/${id}/askPermission`, "", {})
                    .then(() => showSuccess('Your request has been sent to team owning the object. Wait till someone approves it'))
                    .catch(msg => showError(msg.message))
            }
        }

        let inodes, app;
        let tagifyTags, tagifyUsers;

        window.addEventListener('load', () => {
            inodes = new INodes();
            app = new App(inodes)
        });
    </script>
</head>

<body>
    <div class="title-bar">
        <div class="maxwidth title-box">

            <div class="title-left-panel">
                <span class="title">i-nodes</span>
            </div>
            <div class="title-mid-panel">
                <div class="search-wrapper">
                    <input id="searchbox" class="search-input searchbox" type="text" placeholder="search">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor"
                        stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="feather feather-search"
                        viewBox="0 0 24 24">
                        <defs></defs>
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                </div>
            </div>
            <div class="title-right-panel">
                <button class="add-btn new-has-tooltip" title="New">
                    <i class="fas fa-plus-circle fa-2x"></i>
                    <div class="new-tooltip">
                        <ul style="list-style-type: none; padding: 0px; text-align: right; margin: 0px">
                            <li class="new-actions" onclick="app.editInode({})">&#128462; New Post</li>
                            <li class="new-actions" onclick="app.createGroup()">&#x1F465; New Group</li>
                            <li class="new-actions" onclick="app.announceApp()">&#x1F4E2; New Announcement</li>
                        </ul>
                    </div>
                </button>
                <button class="notification-btn" style="position:relative" onclick="app.openNotifications()">
                    <i class="fas fa-bell fa-2x"></i>
                    <b id="notifcount"
                        style="position: absolute; display: none; top: 0px; right: 0px; background: orange; color: white; padding: 3px 5px; border-radius: 50%; font-size: 0.8em"></b>
                </button>
                <button class="profile-btn new-has-tooltip">
                    <i class="fas fa-user fa-2x"></i>
                    <div class="new-tooltip">
                        <ul style="list-style-type: none; padding: 0px; text-align: right; margin: 0px">
                            <li class="new-actions" onclick="app.searchUser()" id='profilebtn'>Account</li>
                            <li class="new-actions" onclick="app.openMyPosts()">My Posts</li>
                            <li class="new-actions" onclick="app.openPRs()">My Pending PRs</li>
                            <li class="new-actions" onclick="app.logout()">Logout</li>
                        </ul>
                    </div>
                </button>
            </div>
        </div>
    </div>
    <div class="content maxwidth">
        <div id="editor-pane"></div>
        <div class="ppane">
            <div class="posts-trending">
                <div class="left-w85">
                    <!-- posts go here -->
                </div>
                <div class="right-w15">
                    <div id="actions" class="actions sidebar-item"></div>
                    <div class="search-facets"></div>
                </div>
            </div>

        </div>
        <hr />
    </div>
    <footer>
        <center>
            &copy; Madhusoodan P
        </center>
    </footer>
</body>

</html>