<!DOCTYPE html>
<html lang="en" ng-app="inodes">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>i-nodes</title>
    <link rel="stylesheet" href="./index.css">
    <script src="/common.js"></script>
    <script src="./tagify.min.js"></script>
    <link rel="stylesheet" href="./tagify.css">
    <script>
        class INodes {
            constructor() {
                let self = this;
                this.klassPromises = {}
                this.scriptPromises = {}
                this.pageSize = 10;
                this.pageNum = 0;
                post('/test-login').catch(() => this.logout())
                get('/klasses').then((data) => {
                    this.klassNames = JSON.parse(data.response)
                    self.populateClassTypes(this.klassNames);
                })
                this.setupSearch();
                this.showUserInfo();
            }
            getKlassNames() {
                return this.klassNames;
            }
            setupSearch() {
                let q = new URL(window.location.href).searchParams.get("q")
                c('searchbox').value = q
                console.log(q)
                this.doSearch(q)
            }
            populateFacets(facets, elemId, searchChar) {
                let self = this;
                let dd = g(elemId)
                dd.innerHTML = ''
                let tags = [];
                Object.keys(facets).forEach(k => facets[k] > 0 ? tags.push({ item: k, hits: facets[k] }) : 1)
                tags.sort((a, b) => b.hits - a.hits);
                tags.forEach(tag => {
                    dd.appendChild(self.createTagElement(tag.item, searchChar, tag.hits))
                    dd.appendChild(document.createElement('br'))
                })
            }
            populateClassTypes(data) {
                let select = g('kclasses');
                select.addEventListener('change', e => this.klassChanged(e.target.value));
                data.forEach(klassName => {
                    select.innerHTML += `<option name='${klassName}'>${klassName}</option>`
                });
                this.klasses = {}
                this.klassChanged(data[0])
            }
            loadKlass(klassName) {
                if (this.klassPromises[klassName]) {
                    return this.klassPromises[klassName];
                }
                let self = this;
                this.klassPromises[klassName] = new Promise((resolve, reject) => {
                    if (self.klasses[klassName]) {
                        return resolve(self.klasses[klassName]);
                    }
                    get(`/klass/${klassName}`).then(d => {
                        self.klasses[klassName] = JSON.parse(d.response);
                        resolve(self.klasses[klassName])
                    })
                });
                return this.klassPromises[klassName]
            }
            klassChanged(klassName) {
                let self = this;
                this.loadKlass(klassName).then(d => {
                    this.renderInput(d.name, undefined, false)
                });
            }
            loadScript(path, elem) {
                return new Promise((resolve, reject) => {
                    var jsElm = document.createElement("script");
                    jsElm.type = "application/javascript";
                    jsElm.src = path;
                    jsElm.addEventListener('load', e => resolve())
                    elem = elem || document.body
                    elem.appendChild(jsElm);
                });
            }
            loadCss(path) {
                return new Promise((resolve, reject) => {
                    var fileref = document.createElement("link");
                    fileref.rel = "stylesheet";
                    fileref.type = "text/css";
                    fileref.href = path;
                    fileref.addEventListener("load", e => resolve())
                    document.getElementsByTagName("head")[0].appendChild(fileref)
                })
            }
            loadKlassScripts(klass) {
                let name = klass.name
                if (this.scriptPromises[name]) {
                    return this.scriptPromises[name]
                }
                this.scriptPromises[name] = new Promise((resolve, reject) => {
                    if (klass.obj) {
                        return resolve(klass.obj)
                    }
                    let proms = [];
                    klass.jsPaths.forEach(s => proms.push(this.loadScript(s)))
                    klass.cssPaths.forEach(s => proms.push(this.loadCss(s)))
                    Promise.all(proms).then(x => {
                        let k = eval(klass.name)
                        klass.obj = new k();
                        resolve(klass.obj)
                    });
                })
                return this.scriptPromises[name]
            }
            renderInput(klassName, obj, force) {
                let self = this;
                this.currentPost = obj
                this.loadKlass(klassName)
                    .then(klass => this.loadKlassScripts(klass))
                    .then(klassObj => {
                        let e = g('editor');
                        e.innerHTML = '';
                        if (!klassObj.inodes_editor || force || obj) {
                            try {
                                klassObj.inodes_editor = klassObj.getEditor(obj)
                            } catch (e) {
                                console.error(e)
                                showError("You don't have permissions to edit this object")
                                throw e
                            }
                        }
                        e.appendChild(klassObj.inodes_editor)
                        g('changenoteeditor').style.display = obj ? 'block' : 'none'
                    });
            }
            loggedIn() {
                return getCookie(USER_KEY)
            }
            showUserInfo() {
                if (this.loggedIn()) {
                    c('title-right-panel').style.display = 'flex'
                    g('actions').innerHTML = ''
                    g('profilebtn').innerHTML = getCurrentUser()
                    this.updateNotificationsCount();
                } else {
                    c('title-right-panel').style.display = 'none'
                    g('actions').innerHTML = `
                        <a class="action-item" href="javascript:inodes.openSignInPage()">Sign In</a>
                        <a class="action-item" href="javascript:inodes.openRegisterPage()">Sign Up</a>
                    `
                }
            }
            updateNotificationsCount() {
                get('/notifications/unseen').then(resp => {
                    let nc = +resp.response;
                    if (nc > 0) {
                        g('notifcount').style.display = 'block';
                        g('notifcount').innerHTML = nc;
                    }
                })
            }
            createGroup() {
                this.triggerSearch('#inodesapp #creategroup')
            }
            openSignInPage() {
                this.triggerSearch('#inodesapp #login')
            }
            post() {
                let self = this;
                let currentClass = g('kclasses').value
                let obj = this.klasses[currentClass].obj
                let content = ''
                try {
                    content = JSON.stringify(obj.getContent());
                } catch (err) {
                    showError(err);
                    return
                }
                let changeNote = this.currentPost ? g('changenote-editor').value : "initial version";
                post(
                    `/data?changeNote=${encodeURIComponent(changeNote)}`,
                    {
                        content,
                        type: currentClass,
                        tags: JSON.parse(g('tags-editor').value).map(t => t.value).concat(obj.getTags ? obj.getTags() : []),
                        visibility: JSON.parse(g('visibility-editor').value).map(u => u.value),
                        savedVisibility: this.currentPost ? (this.currentPost.savedVisibility || ['none']) : ['none'],
                        id: this.currentPost ? this.currentPost.id : undefined
                    },
                    {
                        "Content-Type": "application/json"
                    }
                )
                    .then(e => { showSuccess('Posted successfully'); self.closeEditor(); })
                    .catch(e => showError(e.message))
            }
            doSearch(str, offset = 0, pageSize = 10) {
                if (this.locked()) {
                    if (!confirm('You might have some unsaved work on the page. Do you really want to continue?'))
                        return;
                    this.unlock()
                }
                callWithWaitUI(c('posts-container'), (done) => {
                    this.search(str, offset, pageSize)
                        .then(d => {
                            this.results = JSON.parse(d.response)
                            if (this.results.results.length < 1) {
                                g('posts').innerHTML = '<div class="no-post-found">No posts found</div>'
                                done();
                                return
                            }
                            this.showResults().finally(() => done())
                            this.populateFacets(this.results.facetResults['tags'], 'toptags', '#');
                            this.populateFacets(this.results.facetResults['type'], 'posttypes', '%');
                            this.populateFacets(this.results.facetResults['owner'], 'topcontributors', '~');
                        }).catch(s => done())
                });
            }
            search(str, offset = 0, pageSize = 10) {
                str = str ? str : ""
                str = str.replace(/\![-\w]+/, "")
                return getLast(`/data?q=${encodeURIComponent(str)}&offset=${offset}&pageSize=${pageSize}&fq=tags&fq=type&fq=owner`)
            }
            showResults() {
                let d = g('posts');
                d.innerHTML = ''
                let self = this
                let proms = []
                let itemsByClass = {};
                this.results.results.forEach(r => {
                    if (!itemsByClass[r.type]) {
                        itemsByClass[r.type] = []
                    }
                    itemsByClass[r.type].push(r)
                    proms.push(self.showCard(d, r));
                })
                return new Promise(resolve => {
                    Promise.all(proms)
                        .then(() => {
                            if (this.results.results.length < this.results.totalResults) {
                                d.appendChild(this.getPaginationItem(this.results));
                            }
                            // call the post display hook
                            Object.keys(itemsByClass).forEach(key => {
                                self.loadKlass(key).then(klassMeta => {
                                    self.loadKlassScripts(klassMeta).then(klass => {
                                        if (klass.postDisplay) {
                                            klass.postDisplay(itemsByClass[key])
                                        }
                                    })
                                })
                            })
                        })
                        .then(() => {
                            resolve();
                        });
                });
            }
            getSearchQuery() {
                return c('searchbox').value;
            }
            getPaginationItem(results) {
                let self = this;
                let resp = function () {
                    let container = {
                        ele: 'div',
                        classList: 'pages',
                        children: []
                    }
                    for (let i = 0; i < results.totalResults; i += self.pageSize) {
                        container.children.push(
                            {
                                ele: 'span',
                                classList: `page-btn ${(i / self.pageSize) == self.pageNum ? "selected" : ""}`,
                                text: i / self.pageSize + 1,
                                evnts: {
                                    click: function (e) {
                                        self.pageNum = i / self.pageSize
                                        self.doSearch(self.getSearchQuery(), i, self.pageSize)
                                    }
                                }
                            }
                        )
                    }
                    return container;
                }
                return render('paginator', resp());
            }
            refresh() {
                this.triggerSearch(this.getSearchQuery())
            }
            deleteInode(id) {
                if (!this.loggedIn()) {
                    return showError('Login to delete content')
                }
                if (!confirm('Are you sure to delete this content?')) {
                    return;
                }
                delet(`/data/${id}`)
                    .then(e => showSuccess(e.response))
                    .then(e => this.refresh())
                    .catch(c => showError(c));
            }
            editInode(obj) {
                if (!this.loggedIn()) {
                    return showError('Login to post / update content')
                }
                g('tags-editor').value = obj.tags.join(' ')
                let tags = obj.tags.map(t => {
                    return { name: t, id: t, value: t, description: "" }
                })
                tagifyTags.settings.whitelist.splice(0, tags.length, ...tags);
                tagifyTags.removeAllTags();
                tagifyTags.addTags(tags);

                g('kclasses').value = obj.type
                this.openEditor(obj, true)
            }
            downvoteInode(id) {
                post(`/posts/downvote/${id}`, {})
                    .then(a => showSuccess(a.response))
                    .catch(m => showError(m));
            }
            upvoteInode(id) {
                post(`/posts/upvote/${id}`, {})
                    .then(a => showSuccess(a.response))
                    .catch(m => showError(m));
            }
            showCard(d, obj) {
                let self = this;
                let template = function (klass, obj) {
                    let card;
                    try {
                        if (obj.needsApproval && getCurrentUser() && getCurrentUser() != obj.owner) {
                            card = klass.getSafeCard(obj);
                        } else {
                            if (obj.content == '') {
                                klass = new NoPermissionKlass()
                            }
                            card = klass.getCard(obj)
                        }
                    } catch (e) {
                        if (obj.content) {
                            obj.content = JSON.parse(obj.content)
                        }
                        card = render('inodes', {
                            ele: 'pre',
                            styles: {
                                width: "95%",
                                'background-color': 'red',
                                color: 'white',
                                padding: "10px",
                                'overflow-y': 'auto'
                            },
                            text: `Error while processing \n${JSON.stringify(obj, null, '\t')}\n\nException: \n${e.stack}`
                        })
                    }
                    let getApproveIcon = () => obj.needsApproval ? [{ ele: 'span', classList: 'action', text: 'approve', evnts: { click: () => self.approveInode(obj.id) } }] : [];
                    return {
                        ele: 'div',
                        classList: 'container',
                        styles: {
                            borderLeft: `solid 4px ${self.randColor()}`,
                            position: 'relative',
                            display: 'flex',
                            'flex-direction': 'column'
                        },
                        children: [
                            self.getContextButtons(klass, obj),
                            {
                                ele: 'div',
                                classList: 'container-parent',
                                children: [
                                    {
                                        preBuilt: true,
                                        ele: card
                                    }
                                ]
                            },
                            {
                                ele: 'div',
                                classList: 'tag-owner-actions',
                                children: [
                                    {
                                        ele: 'div',
                                        classList: 'tag-owner',
                                        children: [
                                            {
                                                preBuilt: true,
                                                ele: self.getTagsElement(obj.tags, obj.owner, obj.type)
                                            },
                                            {
                                                ele: 'div',
                                                classList: 'user-time',
                                                styles: { float: 'right' },
                                                children: [
                                                    {
                                                        ele: 'span',
                                                        classList: 'postowner',
                                                        text: `${obj.owner}`,
                                                        evnts: {
                                                            click: function (e) {
                                                                self.searchUser(obj.owner);
                                                            }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        classList: 'posttime',
                                                        styles: {
                                                            'font-size': '0.7em'
                                                        },
                                                        text: `${self.getLocalDateTime(obj.postTime)}`
                                                    }
                                                ]
                                            },

                                        ]
                                    },
                                    {
                                        ele: 'div',
                                        classList: 'actions-list',
                                        children: [
                                            {
                                                ele: 'div',
                                                classList: 'actions',
                                                children: [
                                                    {
                                                        ele: 'span',
                                                        html: `&#x25B2 ${obj.votes || 0}`,
                                                        classList: 'action-upvote',
                                                        evnts: {
                                                            click: function (e) { self.upvoteInode(obj.id) }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        html: `&#x25BC`,
                                                        classList: 'action-downvote',
                                                        evnts: {
                                                            click: function (e) { self.downvoteInode(obj.id) }
                                                        }
                                                    },
                                                    ...(!getCurrentUser() ? [] : [{
                                                        ele: 'span',
                                                        text: 'edit',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { self.editInode(obj) }
                                                        }
                                                    }]),
                                                    ...(!klass.getCopyContent ? [] : [{
                                                        ele: 'span',
                                                        text: 'copy',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: () => self.copyFormatted(klass.getCopyContent(obj))
                                                        }
                                                    }]),
                                                    ...(!getCurrentUser() ? [] : [{
                                                        ele: 'span',
                                                        text: 'delete',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { self.deleteInode(obj.id) }
                                                        }
                                                    }]),
                                                    {
                                                        ele: 'span',
                                                        text: 'comment(s)',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { self.commentInode(obj) }
                                                        }
                                                    },
                                                    {
                                                        ele: 'span',
                                                        text: 'share',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { window.location = `?q=@${obj.id}` }
                                                        }
                                                    },
                                                    ...(!getCurrentUser() ? [] : [{
                                                        ele: 'span',
                                                        text: 'watch',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { self.watchDoc(obj.id) }
                                                        }
                                                    }])
                                                ]
                                            },
                                            {
                                                ele: 'div',
                                                classList: 'actions',
                                                styles: { float: 'right' },
                                                children: [
                                                    {
                                                        ele: 'span',
                                                        classList: 'action',
                                                        text: 'history',
                                                        evnts: { click: () => self.triggerSearch(`#inodesapp #history !${obj.id}`) }
                                                    },
                                                    ...(!getCurrentUser() ? [] : [{
                                                        ele: 'span',
                                                        classList: 'action',
                                                        text: 'flag',
                                                        evnts: { click: () => self.flagInode(obj.id) }
                                                    }]),
                                                    ...getApproveIcon(),
                                                    ...(getCurrentUser() != 'admin' ? [] : [{
                                                        ele: 'span',
                                                        text: 'trust',
                                                        classList: 'action',
                                                        evnts: {
                                                            click: function (e) { self.trustInode(obj.id); }
                                                        }
                                                    }])
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                ele: 'div',
                                classList: 'comments-pane',
                                attribs: {
                                    id: `comment-pane-${obj.id}`
                                },
                                children: [
                                    {
                                        ele: 'div',
                                        styles: {
                                            display: 'flex',
                                            marginBottom: '10px'
                                        },
                                        children: [
                                            {
                                                ele: 'textarea',
                                                attribs: {
                                                    id: `comment-${obj.id}`,
                                                    rows: 2
                                                },
                                                styles: {
                                                    width: '90%',
                                                    border: 'solid 1px gray',
                                                    resize: 'none'
                                                }
                                            },
                                            {
                                                ele: 'button',
                                                text: 'Post',
                                                styles: {
                                                    width: '10%'
                                                },
                                                evnts: {
                                                    click: function (e) {
                                                        post(
                                                            `/posts/comment/${obj.id}`,
                                                            g(`comment-${obj.id}`).value
                                                        ).then(x => self.addCommentToList(`oldcomments-${obj.id}`, JSON.parse(x.response)))
                                                            .catch(e => showError(e.message))
                                                    }
                                                }
                                            }
                                        ]
                                    },
                                    {
                                        ele: 'div',
                                        attribs: {
                                            id: `oldcomments-${obj.id}`
                                        }
                                    }
                                ]
                            }
                        ]
                    };
                }
                if (!obj.type || obj.type == "") {
                    d.appendChild(render('inode', template(undefined, obj)));
                    return;
                }
                return new Promise(function (resolve, reject) {
                    self.loadKlass(obj.type).then(klassMeta => {
                        self.loadKlassScripts(klassMeta).then(klass => {
                            d.appendChild(render('inode', template(klass, obj)));
                            resolve()
                        })
                    })
                });
            }

            copyFormatted(html) {
                let clipboardDiv;
                if (!this.copyClipBoardSet) {
                    clipboardDiv = document.createElement('div');
                    clipboardDiv.style.fontSize = '12pt'; // Prevent zooming on iOS
                    // Reset box model
                    clipboardDiv.style.border = '0';
                    clipboardDiv.style.padding = '0';
                    clipboardDiv.style.margin = '0';
                    // Move element out of screen 
                    clipboardDiv.style.position = 'fixed';
                    clipboardDiv.style['right'] = '-9999px';
                    clipboardDiv.style.top = (window.pageYOffset || document.documentElement.scrollTop) + 'px';
                    // more hiding
                    clipboardDiv.setAttribute('readonly', '');
                    clipboardDiv.style.opacity = 0;
                    clipboardDiv.style.pointerEvents = 'none';
                    clipboardDiv.style.zIndex = -1;
                    clipboardDiv.setAttribute('tabindex', '0'); // so it can be focused
                    clipboardDiv.innerHTML = '';
                    document.body.appendChild(clipboardDiv);
                    this.copyClipBoardSet = true;
                    this.clipboardDiv = clipboardDiv;
                }
                clipboardDiv = this.clipboardDiv;

                clipboardDiv.innerHTML = html;

                var focused = document.activeElement;
                clipboardDiv.focus();

                window.getSelection().removeAllRanges();
                var range = document.createRange();
                range.setStartBefore(clipboardDiv.firstChild);
                range.setEndAfter(clipboardDiv.lastChild);
                window.getSelection().addRange(range);

                var ok = false;
                try {
                    if (document.execCommand('copy')) ok = true; else console.log('execCommand returned false !');
                } catch (err) {
                    console.log('execCommand failed ! exception ' + err);
                }

                focused.focus();
            }

            watchDoc(id) {
                post(
                    `/subscribe?subscriberType=USER&subscriberId=${getCurrentUser()}&objTyp=DOC&objId=${id}&event=ALL`,
                    "",
                    {}
                ).then(r => showSuccess('Subscribed'))
                    .catch(r => showError(r.message))
            }

            trustInode(id) {
                post(`/trust/${id}`)
                    .then(r => showSuccess('Trusted'))
                    .catch(r => showError(r.message))
            }

            getContextButtons(klass, obj) {
                let self = this;
                let getLockIcon = () => obj.visibility != 'g-public' ? [{ ele: 'span', html: '&#128274;', attribs: { title: 'Private (only visible to you)' } }] : []
                return {
                    ele: 'div',
                    classList: 'context-btns',
                    children: [
                        ...getLockIcon(),
                        {
                            ele: 'span',
                            classList: 'context-btn',
                            html: '&#x26F6;',
                            attribs: { title: 'Full screen' },
                            evnts: {
                                click: function () {
                                    let x = document.createElement('div')
                                    x.classList = 'fullscreen-inode'
                                    document.body.appendChild(x)

                                    let cardEle = this.parentNode.nextSibling.childNodes[0], cardParent = cardEle.parentNode;

                                    let closeBtn = document.createElement('span')
                                    closeBtn.classList = 'closefullscreen-btn'
                                    closeBtn.innerHTML = '&#x2715;'
                                    closeBtn.addEventListener('click', function () {
                                        cardEle.remove();
                                        cardParent.appendChild(cardEle)
                                        x.remove();
                                        document.querySelector('.content').style.display = 'block'
                                    })

                                    document.querySelector('.content').style.display = 'none'
                                    x.appendChild(cardEle)
                                    x.appendChild(closeBtn)
                                }
                            }
                        }
                    ]
                }
            }

            approveInode(docId) {
                post(`/data/${docId}/approve`, {}, {})
                    .then(x => showSuccess('Approved'))
                    .catch(x => showError(x.message))
            }

            flagInode(docId) {
                post(`/data/${docId}/flag`, {}, {})
                    .then(x => showSuccess('Flagged, a notification is sent to owner and security team'))
                    .catch(x => showError(x.message))
            }

            searchUser(user) {
                this.triggerSearch(`#user !${user}`)
            }

            commentInode(obj) {
                let self = this;
                g(`comment-pane-${obj.id}`).style.display = "block";
                let container = g(`oldcomments-${obj.id}`);
                container.innerHTML = ""
                get(`/posts/comments/${obj.id}`).then(comments => {
                    comments = JSON.parse(comments.response)
                    comments.sort((a, b) => a.time - b.time).forEach(comment => {
                        self.addCommentToList(`oldcomments-${obj.id}`, comment)
                    })
                })
            }

            addCommentToList(parentId, comment) {
                let container = g(parentId);
                let c = document.createElement('div')
                c.classList = "inode-comment-card"
                c.innerHTML = `${JSON.parse(comment.txt).replaceAll(/@([0-9A-Za-z]+)/g, '<a href="/?q=%23user !$1" target="_blank" >$1</a>')} - <a href="/?q=%23user !${comment.userid}">${comment.userid}</a> ${this.getCommentContextButtons(comment)}`
                container.appendChild(c)
            }

            getCommentContextButtons(c) {
                if (c.userid == getCurrentUser()) {
                    return `<span onclick='inodes.deleteComment("${c.postid}/${c.userid}/${c.itime}", this.parentElement)' class='comment-action-btn'>delete</span>`
                }
                return ''
            }

            deleteComment(id, parEle) {
                delet(`/posts/comment/${id}`).then(parEle.remove())
            }

            getLocalDateTime(ep) {
                var d = new Date(ep);
                return `${d.toLocaleDateString()}`
            }

            randColor() {
                var letters = '0123456789ABCDEF';
                var color = '#';
                for (var i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }

            getTagsElement(tags, user, type) {
                let x = document.createElement('div')
                x.classList = "tags-container"
                if (!tags) return x;
                let self = this;
                tags.forEach(tag => {
                    x.appendChild(this.createTagElement(tag, '#'));
                });
                user && x.appendChild(this.createTagElement(user, '~'))
                type && x.appendChild(this.createTagElement(type, '%'))
                return x;
            }

            getTagDetails(tag) {
                get(`/tags/${tag}`)
                    .then(x => console.log(x.response))
            }

            getTagToolTip(tag, char, hits) {
                if (!this._tagCache) {
                    this._tagCache = {};
                }
                let tagCache = this._tagCache;
                return new Promise((resolve, reject) => {
                    let dprom;
                    if (char != '#') {
                        dprom = new Promise((res, rej) => {
                            res({
                                ele: 'span',
                                classList: 'desc',
                                text: char != '%' ? `Content created by ${tag}` : `Content of type ${tag}`
                            })
                        })
                    } else {
                        dprom = new Promise((res, rej) => {
                            if (tagCache[tag]) {
                                res(tagCache[tag])
                                return;
                            }
                            get(`/tags/${tag}`)
                                .then(r => JSON.parse(r.response))
                                .then(r => {
                                    tagCache[tag] = {
                                        ele: 'div',
                                        children: [
                                            {
                                                ele: 'div',
                                                classList: 'doccount',
                                                text: `${Object.values(r.extra.docCount).reduce((x, z) => x + z, 0)} doc(s)`
                                            },
                                            {
                                                ele: 'span',
                                                classList: 'desc',
                                                text: r.basic.description || "No description avaialable. Edit and add a description"
                                            }
                                        ]
                                    }
                                    res(tagCache[tag])
                                })
                        })
                    }
                    dprom.then(x => {
                        resolve(render('tag-ttc', x))
                    })
                })
            }

            createTagElement(tag, char, hits) {
                let self = this;
                let icon = (tag, char) => char == '%' ? tag + ".png" : 'tag.png';
                return render('tag', {
                    ele: 'span',
                    classList: 'has-tooltip',
                    children: [
                        {
                            ele: 'span',
                            classList: 'container',
                            children: [
                                
                                { ele: 'span', text: (hits ? "" : char) + tag }
                            ]
                        },
                        ...(hits ? [{ ele: 'span', classList: 'hits', text: ` x ${hits}` }] : []),
                        {
                            ele: 'div',
                            classList: 'tooltip',
                            children: [
                                {
                                    ele: 'div',
                                    classList: 'tt-title-container',
                                    children: [
                                        {
                                            ele: 'b',
                                            classList: 'tt-title',
                                            text: tag
                                        },
                                        ...(char == '#' ? [] : [
                                            {
                                                ele: 'span', text: ' (pseudo tag)', attribs: { style: 'font-size: 0.8em;' }
                                            }
                                        ]),
                                    ]
                                },
                                {
                                    ele: 'div',
                                    classList: 'desc'
                                },
                                ...(char == '#' ? [{
                                    ele: 'div',
                                    children: [
                                        ...(getCurrentUser() ? [{
                                            ele: 'span',
                                            text: 'watch',
                                            classList: 'tt-btn',
                                            evnts: {
                                                click: function () {
                                                    post(`/subscribe?subscriberType=USER&subscriberId=${getCurrentUser()}&objTyp=TAG&objId=${tag}&event=ALL`)
                                                        .then(e => showSuccess(`You have subscribed to tag: ${tag}`))
                                                        .catch(e => showError(e.message))
                                                }
                                            }
                                        }] : []
                                        ),
                                        {
                                            ele: 'span',
                                            text: 'view',
                                            classList: 'tt-btn',
                                            evnts: {
                                                click: function () {
                                                    self.triggerSearch(`#inodesapp #viewtag !${tag}`)
                                                }
                                            }
                                        }
                                    ]
                                }] : []
                                )
                            ],
                            evnts: {
                                click: e => e.stopPropagation()
                            }
                        }
                    ],
                    evnts: {
                        click: function (e) {
                            let q = ""
                            if (e.ctrlKey) {
                                q = c('searchbox').value + " "
                            }
                            q += `${char}${tag}`
                            self.triggerSearch(q)
                        },
                        mouseenter: function (e) {
                            this.setAttribute('data-intime', + new Date());
                            let ltim = setTimeout(() => {
                                let lt = this.getAttribute('data-intime');
                                if (!lt) return;
                                lt = +lt;
                                let ttc = this.querySelector('.tag-tooltip');
                                let tt = this.querySelector('.tag-desc');
                                if (!tt.getAttribute('desc-resolved')) {
                                    self.getTagToolTip(tag, char)
                                        .then(x => {
                                            tt.appendChild(x);
                                            tt.setAttribute('desc-resolved', true)
                                        })
                                }
                                ttc.style.visibility = 'visible';
                            }, 600)
                            this.setAttribute('ltimer', ltim)
                        },
                        mouseleave: function (e) {
                            this.querySelector('.tag-tooltip').style.visibility = 'hidden'
                            this.setAttribute('data-intime', undefined);
                            clearTimeout(this.getAttribute('ltimer'))
                        }
                    }
                })
            }

            openEditor(obj, force) {
                this.renderInput(obj ? obj.type : g('kclasses').value, obj, true)
                g('editor-pane').style.display = 'block';
                g('kclasses').disabled = obj ? true : false

                let visibility = obj ? (obj.needsApproval ? obj.savedVisibility : obj.visibility) : ['g-public'];
                visibility = visibility.map(v => {
                    return { name: v.substring(2), id: v, value: v, type: v[0] == 'g' ? 'group' : 'user' }
                });
                tagifyUsers.settings.whitelist.splice(0, visibility.length, ...visibility)
                tagifyUsers.removeAllTags();
                tagifyUsers.addTags(visibility)
            }
            closeEditor() {
                g('editor-pane').style.display = 'none';
            }
            logout(e) {
                post(
                    '/auth/logout',
                    {},
                    { 'Content-Type': 'application/json' }
                )
                eraseCookie(USER_KEY)
                eraseCookie(TOK_KEY)
                this.showUserInfo()
            }
            register() {
                post(
                    '/auth/register',
                    {
                        user: c('usernamebox').value,
                        password: c('passwordbox').value
                    },
                    {
                        'Content-Type': 'application/json'
                    }
                )
                    .then(() => showSuccess('registration successful. verify your email address by clicking on the link in the email sent to you'))
                    .catch(m => showError(`registration failed. reason: ${m}`))
            }
            triggerSearch(q) {
                c('searchbox').value = q;
                this.doSearch(q)
            }
            openAccount() {
                this.triggerSearch(`#user !${getCurrentUser()}`)
            }
            openMyPosts() {
                this.triggerSearch(`~${getCurrentUser()}`)
            }
            openNotifications() {
                this.triggerSearch(`#inodesapp #notifications`)
            }
            openPRs() {
                this.triggerSearch(`#inodesapp #mypermissionrequests`)
            }
            announceApp() {
                this.triggerSearch(`#inodesapp #notifier`)
            }
            openRegisterPage() {
                this.triggerSearch('#register #inodesapp')
            }
            lock() { this._lock = true }
            locked() { return this._lock }
            unlock() { this._lock = false }
            runCommand(scriptText, pnode, callBack, finishCallback) {

                if (!pnode) {
                    pnode = document.createElement('div');
                }
                pnode.innerHTML = ''

                let out;
                if (pnode) {
                    out = document.createElement('pre');
                    out.style = "background-color: #f5f5f5; padding: 10px; color: black; width: 100%; height: 200px; overflow: auto"
                    pnode.appendChild(out);
                }

                let ajax = function (method, url, data, hdrs) {
                    return new Promise((resolve, reject) => {
                        var xhttp = new XMLHttpRequest();
                        xhttp.onreadystatechange = function () {
                            if (this.readyState == 4 && this.status == 200) {
                                resolve({ response: this.responseText })
                            }
                            if (this.status == 401) {
                                reject(401);
                            }
                        };
                        xhttp.open(method, url, true);
                        hdrs && Object.keys(hdrs).forEach(key => xhttp.setRequestHeader(key, hdrs[key]))
                        xhttp.send(data);
                    });
                }
                let post = function (url, data, hdrs) {
                    return ajax('POST', url, JSON.stringify(data), hdrs);
                }

                return new Promise((resolve, reject) => {
                    post(
                        'http://inedctst01:5000/cli',
                        { script: scriptText },
                        { 'Content-Type': 'application/json' }
                    ).then(d => {
                        d = d.response
                        resolve(d)
                        var source = new EventSource(`http://inedctst01:5000/poll?rid=${d}`);
                        source.onmessage = function (event) {
                            if (event.data == 'MPATAKI-STOP_EVENT-SOURCE') {
                                event.target.close()
                                if (finishCallback)
                                    finishCallback()
                                return
                            }
                            if (out)
                                out.innerHTML += event.data + "<br/>"
                            if (callBack)
                                callBack(event.data)
                        }
                    })
                });
            }
        }

        class NoPermissionKlass {
            getCard(obj) {
                let noPermSpec = {
                    ele: 'div',
                    attribs: { style: 'padding: 50px' },
                    children: [
                        { ele: 'span', text: "You dont' have permissions to access this info. But you can " },
                        { ele: 'button', text: 'request', evnts: { click: () => { this.requestAccess(obj.id) } } },
                        { ele: 'span', text: " for it" }
                    ]
                };
                let permRequestedSpec = {
                    ele: 'div',
                    attribs: { style: 'padding: 50px' },
                    children: [
                        { ele: 'span', text: "Your request to get a permission on this object is still pending. You can track all your pending permission requests " },
                        { ele: 'a', text: 'here', attribs: { href: '/?q=%23inodesapp %23mypermissionrequests' } }
                    ]
                }
                return render('no-permission', obj.readState == 'PERM_REQUESTED' ? permRequestedSpec : noPermSpec)
            }
            getEditor() {
                throw new Error("You don't have permissions to edit this object")
            }
            requestAccess(id) {
                post(`/data/${id}/askPermission`, "", {})
                    .then(() => showSuccess('Your request has been sent to team owning the object. Wait till someone approves it'))
                    .catch(msg => showError(msg.message))
            }
        }

        let inodes;
        let tagifyTags, tagifyUsers;

        window.addEventListener('load', () => {
            inodes = new INodes();
            tagifyUsers = tagify(g('visibility-editor'), 'user')
            tagifyTags = tagify(g('tags-editor'), 'tag')
        });
    </script>

</head>

<body>
    <div class="title-bar">
        <div class="maxwidth title-box">

            <div class="title-left-panel">
                <span class="title">i-nodes</span>
            </div>
            <div class="title-mid-panel">
                <div class="search-wrapper">
                    <input class="search-input searchbox" type="text" placeholder="search"
                        oninput="inodes.doSearch(this.value)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor"
                        stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="feather feather-search"
                        viewBox="0 0 24 24">
                        <defs></defs>
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                </div>
            </div>
            <div class="title-right-panel">
                <button class="add-btn new-has-tooltip" title="New">
                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                        stroke-linejoin="round" class="feather feather-plus">
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                    <div class="new-tooltip">
                        <ul style="list-style-type: none; padding: 0px; text-align: right; margin: 0px">
                            <li class="new-actions" onclick="inodes.openEditor(undefined, true)">&#128462; New Post</li>
                            <li class="new-actions" onclick="inodes.createGroup()">&#x1F465; New Group</li>
                            <li class="new-actions" onclick="inodes.announceApp()">&#x1F4E2; New Announcement</li>
                        </ul>
                    </div>
                </button>
                <button class="notification-btn" style="position:relative" onclick="inodes.openNotifications()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-bell">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                        <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                    </svg>
                    <b id="notifcount"
                        style="position: absolute; display: none; top: 0px; right: 0px; background: orange; color: white; padding: 3px 5px; border-radius: 50%; font-size: 0.8em"></b>
                </button>
                <button class="profile-btn new-has-tooltip">
                    <span>&#x1F464;</span>
                    <div class="new-tooltip">
                        <ul style="list-style-type: none; padding: 0px; text-align: right; margin: 0px">
                            <li class="new-actions" onclick="inodes.openAccount()" id='profilebtn'>Account</li>
                            <li class="new-actions" onclick="inodes.openMyPosts()">My Posts</li>
                            <li class="new-actions" onclick="inodes.openPRs()">My Pending PRs</li>
                            <li class="new-actions" onclick="inodes.logout()">Logout</li>
                        </ul>
                    </div>
                </button>
            </div>
        </div>
    </div>
    <div class="content maxwidth">
        <div id="editor-pane">
            <span onclick="inodes.closeEditor()" class="closebtn">&#10006;</span>
            <label for="kclasses" class="">Post type: </label><br />
            <select id="kclasses"></select><br /><br />
            <div id="editor"></div><br />
            <label for="tags-editor">Tags</label><br />
            <input type="text" id="tags-editor" placeholder="start typing a tag name. eg edc hack"></input><br />
            <label for="visibility-editor">Visibility</label><br />
            <input type="text" id="visibility-editor" placeholder="start typing a user or group name"></input>
            <div id="changenoteeditor">
                <label for="changenote-editor">What changed?</label><br />
                <input id="changenote-editor" placeholder="describe what changed in this version"></input><br />
            </div>
            <br />
            <button onclick="inodes.post()">Post</button>
        </div>
        <div class="ppane">
            <div class="posts-trending">
                <div class="left-w85">
                    <div class="posts-container">
                        <div id="posts"></div>
                    </div>
                </div>
                <div class="right-w15">
                    <div id="actions" class="actions sidebar-item">
                    </div>
                    <div>
                        <h4>Post types</h4>
                        <div id="posttypes" class="sidebar-item">
                        </div>
                    </div>
                    <div>
                        <h4>Top tags</h4>
                        <div id="toptags" class="sidebar-item">
                        </div>
                    </div>
                    <div>
                        <h4>Top contributors</h4>
                        <div id="topcontributors" class="sidebar-item">
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <hr />
    </div>
    <footer>
        <center>
            &copy; Madhusoodan P
        </center>
    </footer>

</body>

</html>
